<!--
@license
Copyright © HatioLab Inc. All rights reserved.
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/things-ajax/things-ajax.html">
<link rel="import" href="../../bower_components/things-form/things-search-form.html">
<link rel="import" href="../../bower_components/things-content/things-resource-menu-content-behavior.html">

<!--
	WCS 실적 리포트 > 시간대 별 생산성
-->
<dom-module id="wcs-hourly-result">
  <template>
    <style>
      :host {
        @apply --layout-vertical;
      }

      .container {
        @apply --layout-flex;
        margin:10px 16px 10px 16px;
        background-color: #FFFFFF;
      }
    </style>

    <!-- 메뉴 메타 조회 Ajax -->
    <things-ajax 
      auto 
      id="resource-meta" 
      method="GET" 
      resource-url="[[menuMetaUrl]]" 
      last-response="{{metaData}}">
    </things-ajax>

    <!-- 검색 폼 -->
    <things-search-form 
      id="search-form" 
      title="[[menuInfo.title]]" 
      form-fields="[[searchFormFields]]"
      select-fields="[[selectFields]]" 
      sort-fields="[[sortFields]]" 
      action-url="[[menuInfo.resource_url]]"
      page="{{page}}" 
      limit="[[limit]]" 
      last-response="{{lastResponse}}">
    </things-search-form>

		<div class="container" id="hourly-chart">
      <canvas id="canvas"></canvas>
    </div>
  </template>

  <script>
    Polymer({
      is: 'wcs-hourly-result',

      behaviors: [
        Things.ResourceMenuContentBehavior
      ],

      properties: {
        /**
         * @description Hourly Chart
         ********************
         * @type {Object}
         */
        hourlyChart: {
          type: Object
        },

        /**
         * @description 검색 데이터 
         ********************
         * @type {Object}
         */
        lastResponse: {
          type: Object,
          observer: '_onDataChanged'
        }
      },

      /**
       * @description Life Cycle
       *******************
       */
      attached: function() {},

      /**
       * @description 데이터 변경시 
       *******************
       * @param {Object} lastResponse
       */
      _onDataChanged: function(lastResponse) {
        var dataset = this.randomActuals();
        this.renderBarChart(dataset);
      },

      /**
       * @description 그리드 데이터를 초기화
       ******************************
       */
      resetData: function() {
        this.items = [];
      },

      /**
       * @description 그리드 데이터를 리프레쉬
       ******************************
       */
      refreshData: function(items) {
        this.items = items;
      },

      randomInt: function() {
        var min = Math.ceil(500);
        var max = Math.floor(600);
        return Math.floor(Math.random() * (max - min)) + min;
      },

      randomData: function(labels) {
        return labels.map(function(i) {
          return this.randomInt();
        }.bind(this));
      },

      /**
       * @description 랜덤 실적 생성
       *******************
       */
      randomActuals: function() {
        var labels = ['08:00', '08:10', '08:20', '08:30', '08:40', '08:50', '09:00', '09:10', '09:20', '09:30', '09:40', '09:50', '10:00', '10:10', '10:20', '10:30', '10:40', '10:50', '11:00', '11:10', '11:20', '11:30', '11:40', '11:50', '12:00', '12:10', '12:20', '12:30', '12:40', '12:50', '13:00', '13:10', '13:20', '13:30', '13:40', '13:50', '14:00', '14:10', '14:20', '14:30', '14:40', '14:50', '15:00', '15:10', '15:20', '15:30', '15:40', '15:50', '16:00', '16:10', '16:20', '16:30', '16:40', '16:50', '17:00', '17:10', '17:20', '17:30', '17:40', '17:50', '18:00'];
        var actual = this.randomData(labels);

        return {
          labels: labels,
          datasets: [{
            label: '실적',
            borderWidth: 1,
            backgroundColor: 'rgba(75,192,192,0.2)',
            borderColor: 'rgba(75,192,192,1)',
            data: actual
          }]
        };
      },

      /**
       * @description 시간대별 차트 렌더링
       *******************
       * @param {Object} dataset
       */
      renderBarChart: function(dataset) {
        // 1. 최초 차트가 그려지기 전 
        if (!this.hourlyChart) {
          var ctx = this.$['canvas'].getContext('2d');
          this.hourlyChart = new Chart(ctx, {
            type: 'bar',
            data: dataset,
            options: {
              responsive: true,
              legend: {
                position: 'top'
              },
              title: {
                display: true,
                text: '시간대별 실적'
              }
            }
          });

          // 2. 차트가 한 번 그려진 이후 
        } else {
          this.hourlyChart.config.data = dataset;
          this.hourlyChart.update();
        }
      }
    })
  </script>
</dom-module>