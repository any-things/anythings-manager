<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/things-ajax/things-ajax.html">
<link rel="import" href="../../bower_components/things-meta/things-named-meta-behavior.html">



<dom-module id="rtn-location-assignment">
   <template>
      <style>:host{@apply --layout-flex;@apply --layout-vertical;@apply --things-default-padding;--grid-gap:10px}#container{@apply --layout-flex;display:grid;grid-template:"a a" auto "b c" auto "f g" 57px "d e" minmax(120px,1fr)/minmax(334px,calc(50% - calc(var(--grid-gap)/ 2))) minmax(334px,calc(50% - calc(var(--grid-gap)/ 2)));grid-gap:var(--grid-gap)}#container>#search-form{grid-area:a}#container>#first-select-form-gridarea{grid-area:b}#container>#second-select-form-gridarea{grid-area:c}#container>#first-gridarea{grid-area:d}#container>#second-gridarea{grid-area:e}#container>#first-summary-gridarea{grid-area:f}#container>#second-summary-gridarea{grid-area:g}things-combo{display:grid;grid-template:"a b c" auto/minmax(62px,15%) minmax(100px,1fr) auto;grid-gap:5px;--things-label:{min-height:25px;color:var(--things-primary-text-color);text-align:right;line-height:25px;padding-right:5px};--things-input:{width:auto!important;padding:3px 5px 2px 5px;-webkit-border-radius:4px;-moz-border-radius:4px;border-radius:4px;border:1px solid rgba(0,0,0,.2);font-size:15px;font-weight:300};--things-picker-button:{width:30px;height:25px;margin-left:2px;-webkit-border-radius:3px;-moz-border-radius:3px;border-radius:3px};}things-combo>label{grid-area:a}things-combo>input.input-size:not(#input){grid-area:b}things-combo>iron-icon{grid-area:c}things-input-field{display:grid;grid:auto/minmax(62px,30%) minmax(100px,1fr);grid-gap:5px;--things-label:{min-height:25px;color:var(--things-primary-text-color);text-align:right;line-height:25px;padding-right:5px};--things-input:{padding:3px 5px 2px 5px;-webkit-border-radius:4px;-moz-border-radius:4px;border-radius:4px;border:1px solid rgba(0,0,0,.2);font-size:15px;font-weight:300};}.margin-zero{margin:0}.padding-zero{padding:0}.select-form{display:grid;grid-template:"a b" auto "c c" auto/1fr 1fr;grid-row-gap:10px}.select-form>.location-input-field{grid-area:a}.select-form>.sku-input-field{grid-area:b}.select-form>.region-combo{grid-area:c}</style>

      
      <things-ajax auto id="resource-meta" method="GET" resource-url="[[menuMetaUrl]]" last-response="{{metaData}}">
      </things-ajax>

      
      <things-ajax id="das-loc-assign" method="POST">
      </things-ajax>

      
      <things-ajax id="first-selected-region-ajax" method="GET">
      </things-ajax>

      
      <things-ajax id="second-selected-region-ajax" method="GET">
      </things-ajax>

      
      <div id="container">
         
         <things-search-form id="search-form" class="margin-zero" form-fields="[[searchFormFields]]" select-fields="[[selectFields]]" sort-fields="[[sortFields]]" action-url="[[menuInfo.resource_url]]" page="{{page}}" limit="[[limit]]" last-response="{{lastResponse}}">
         </things-search-form>

         
         <div id="first-select-form-gridarea" class="select-form">
            
            <things-input-field id="first-loc-input-field" class="location-input-field" name="location" label="[[labels.location]]" readonly="true">
            </things-input-field>
            
            <things-input-field id="first-sku-input-field" class="sku-input-field" name="sku" label="[[labels.sku]]" readonly="true">
            </things-input-field>
            
            <things-combo id="first-select-combo" class="region-combo padding-zero margin-zero" except-empty="true" label="[[labels.regionSelect]]" label-path="description" value-path="name">
            </things-combo>
         </div>

         
         <div id="second-select-form-gridarea" class="select-form">
            
            <things-input-field id="second-loc-input-field" class="location-input-field" name="location" label="[[labels.location]]" readonly="true">
            </things-input-field>
            
            <things-input-field id="second-sku-input-field" class="sku-input-field" name="sku" label="[[labels.sku]]" readonly="true">
            </things-input-field>
            
            <things-combo id="second-select-combo" class="region-combo padding-zero margin-zero" except-empty="true" label="[[labels.regionSelect]]" label-path="description" value-path="name">
            </things-combo>
         </div>

         
         <things-resource-grid id="first-summary-gridarea" class="padding-zero" model="[[sumGridModel]]" columns="[[sumGridColumns]]" config="[[sumGridConfig]]" buttons="" fixed-column-count="0">
         </things-resource-grid>
         
         <things-resource-grid id="first-gridarea" order="first" class="padding-zero" model="[[gridModel]]" columns="[[myGridColumns]]" config="[[gridConfig]]" limit="10000" fixed-column-count="0">
         </things-resource-grid>

         
         <things-resource-grid id="second-summary-gridarea" class="padding-zero" model="[[sumGridModel]]" columns="[[sumGridColumns]]" config="[[sumGridConfig]]" buttons="" fixed-column-count="0">
         </things-resource-grid>
         
         <things-resource-grid id="second-gridarea" order="second" class="padding-zero" model="[[gridModel]]" columns="[[myGridColumns]]" config="[[gridConfig]]" limit="10000" fixed-column-count="0" buttons="[[buttons]]">
         </things-resource-grid>
      </div>
   </template>

   <script>Polymer({is:"rtn-location-assignment",behaviors:[Things.MsgBoxBehavior,Things.NamedMetaBehavior],properties:{labels:{type:Object,value:function(){return{regionSelect:Things.DataGlobal.t("title.region_select"),location:Things.DataGlobal.t("label.location"),sku:Things.DataGlobal.t("label.sku")}}},gridConfig:{type:Object,value:function(){return{options:{edit:{pasteEnabled:!1},display:{fitStyle:"fill"},checkBar:{exclusive:!0}}}}},sumGridConfig:{type:Object,value:function(){return{options:{edit:{pasteEnabled:!1},rowIndicator:{visible:!1},display:{fitStyle:"fill"},checkBar:{visible:!1}}}}},sumGridModel:{type:Array,value:function(){return[{fieldName:"sku_cnt",dataType:"number"},{fieldName:"cust_qty",dataType:"number"},{fieldName:"pcs_qty",dataType:"number"}]}},sumGridColumns:{type:Array,value:function(){return[{fieldName:"sku_cnt",name:"sku_cnt",header:{text:Things.DataGlobal.t("label.sku_cnt")},editable:!1,styles:{textAlignment:"far",numberFormat:"#,###"}},{fieldName:"cust_qty",name:"cust_qty",header:{text:Things.DataGlobal.t("label.cust_qty")},editable:!1,styles:{textAlignment:"far",numberFormat:"#,###"}},{fieldName:"pcs_qty",name:"pcs_qty",header:{text:Things.DataGlobal.t("label.pcs_qty")},editable:!1,styles:{textAlignment:"far",numberFormat:"#,###"}}]}}},listeners:{"resource-meta.things-ajax-response":"_gotMeta","search-form.things-search-form-configured":"_initSearchForm","first-select-combo.things-combo-value-changed":"searchFirstRegion","second-select-combo.things-combo-value-changed":"searchSecondRegion","first-selected-region-ajax.things-ajax-response":"setFirstGridData","second-selected-region-ajax.things-ajax-response":"setSecondGridData","things-grid-configured":"_gridConfigured","second-gridarea.swap-btn-tap":"_callSwapAjax","second-gridarea.reset-btn-tap":"_reset","das-loc-assign.things-ajax-response":"_openSuccessToProcessMsg","search-form.things-form-pre-submit":"_reset","search-form.things-form-submit-success":"_onSubmitSuccess"},_gotMeta:function(e){this._setColumns()},_setColumns:function(){var e=this.gridColumns,t=e.findIndex(function(e){return"side_cd"===e.name});t&&(e[t].editable=!1),this.myGridColumns=e},_initSearchForm:function(e){e.target.setFormData({batch_id:this.batchId}),e.target.submitMyForm()},searchFirstRegion:function(e){var t=this.$["first-select-combo"].value;if(t){var s=this.menuInfo.resource_url+"/"+this.batchId+"/"+t+"/locations";this.$["first-selected-region-ajax"].resourceUrl=s,this.$["first-selected-region-ajax"].generateRequest()}},searchSecondRegion:function(e){var t=this.$["second-select-combo"].value;if(t){var s=this.menuInfo.resource_url+"/"+this.batchId+"/"+t+"/locations";this.$["second-selected-region-ajax"].resourceUrl=s,this.$["second-selected-region-ajax"].generateRequest()}},setFirstGridData:function(e){this.$["first-gridarea"].getGridDataSet().setRows(e.detail&&e.detail.locList),this.$["first-summary-gridarea"].getGridDataSet().setRows(e.detail&&[e.detail.summary])},setSecondGridData:function(e){this.$["second-gridarea"].getGridDataSet().setRows(e.detail&&e.detail.locList),this.$["second-summary-gridarea"].getGridDataSet().setRows(e.detail&&[e.detail.summary])},_gridConfigured:function(e){switch(e.target.grid.autoFill().setEnabled(!1),e.target.id){case"first-gridarea":case"second-gridarea":var t=this.$[e.target.getAttribute("order")+"-loc-input-field"],s=this.$[e.target.getAttribute("order")+"-sku-input-field"];e.target.grid.onRowChecked=function(e,i,a){var o=i.getRowObject();t.value=o.loc_cd,s.value=o.sku_cd,t["batch-id"]=o.batch_id}}},_callSwapAjax:function(e){firstLoc=this.$["first-loc-input-field"].value,secondLoc=this.$["second-loc-input-field"].value,firstLoc&&secondLoc?firstLoc!==secondLoc?(this.$["das-loc-assign"].resourceUrl=this.menuInfo.resource_url+"/"+this.$["first-loc-input-field"]["batch-id"]+"/"+firstLoc+"/"+this.$["second-loc-input-field"]["batch-id"]+"/"+secondLoc+"/swap",this.$["das-loc-assign"].generateRequest()):this.openConfirmMsg({type:"info",title:Things.DataGlobal.t("title.info"),text:Things.DataGlobal.t("text.is_same_location"),showCancelButton:!1}):this.openConfirmMsg({type:"info",title:Things.DataGlobal.t("title.info"),text:Things.DataGlobal.t("text.please_choose_location"),showCancelButton:!1})},_getCurrentBatchId:function(){return this.$["search-form"].serializeMyForm().batch_id},_openSuccessToProcessMsg:function(e){refresh=function(){this.searchFirstRegion(),this.searchSecondRegion(),this.$["first-loc-input-field"].value="",this.$["first-sku-input-field"].value="",this.$["second-loc-input-field"].value="",this.$["second-sku-input-field"].value=""}.bind(this),this.openConfirmMsg({type:"success",title:Things.DataGlobal.t("label.success"),text:Things.DataGlobal.t("text.Success to Process"),showCancelButton:!1},refresh)},_callLocationInfo:function(e){this.$["first-select-combo"].value=e[0]?e[0][this.$["first-select-combo"].valuePath]:"",this.$["second-select-combo"].value=e[0]?e[0][this.$["second-select-combo"].valuePath]:"",this.searchFirstRegion(),this.searchSecondRegion()},_reset:function(){try{this.$["first-loc-input-field"].value="",this.$["first-sku-input-field"].value="",this.$["second-loc-input-field"].value="",this.$["second-sku-input-field"].value="",this.$["first-gridarea"].grid.checkAll(!1),this.$["second-gridarea"].grid.checkAll(!1)}catch(e){}},_setComboItems:function(e){this.$["first-select-combo"].items=e,this.$["second-select-combo"].items=e},_onSubmitSuccess:function(e){var t=e.detail;this.batchId=this._getCurrentBatchId(),0===t.length&&this._purgeGrid(),this._callLocationInfo(t),this._setComboItems(t)},_purgeGrid:function(){this.querySelectorAll("things-resource-grid").forEach(function(e){e.getGridDataSet().setRows([])})}})</script>
</dom-module>