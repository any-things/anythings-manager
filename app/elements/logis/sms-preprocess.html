<!--
@license
Copyright © HatioLab Inc. All rights reserved.
-->
<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/things-ajax/things-ajax.html">
<link rel="import" href="../../bower_components/things-form/things-search-form.html">
<link rel="import" href="../../bower_components/things-grid/things-resource-grid.html">
<link rel="import" href="../../bower_components/things-content/things-resource-menu-content-behavior.html">

<!--
sms 주문 가공 화면
-->

<dom-module id="sms-preprocess">
  <template>
    <style>
      :host {
        @apply --layout-vertical;
        padding: 5px 15px 0px 15px;
        height: 100%;
      }

      .container {
        @apply --layout-flex;
        display: grid;
        grid-template:
          "sea sea sea"auto "gsm gsm gsm"57px "gri reg reg"1fr / 1fr minmax(80px, 0.2fr) 0.8fr;
        grid-gap: 15px;
      }

      #search-form {
        grid-area: sea;
      }

      #summary-grid {
        grid-area: gsm;
      }

      #region-grid {
        grid-area: reg;
      }

      #grid {
        grid-area: gri;
      }

      paper-toolbar {
        height: 50px;
      }

      paper-toolbar::shadow #bottomBar {
        height: 50px;
        @apply --layout-horizontal;
        @apply --layout-end-justified;
        padding: 0 10px;
      }

      .margin-zero {
        margin: 0px;
      }

      .padding-zero {
        padding: 0px;
      }
    </style>

    <!-- 메뉴 메타 정보 수신 Ajax -->
    <things-ajax auto id="resource-meta" method="GET" resource-url="[[menuMetaUrl]]" last-response="{{metaData}}">
    </things-ajax>

    <!-- 여러 배치 한꺼번에 작업 지시 Ajax -->
    <things-ajax id="instruct-jobs-ajax" resource-url="job_batches/instruct/batches" resource-action="create">
    </things-ajax>

    <!-- 주문 가공 데이터 조회 Ajax -->
    <things-ajax id="search-preprocessing-ajax" resource-url="order_preprocesses" resource-action="index">
    </things-ajax>

    <!-- 주문 가공 데이터 호기 자동 지정 Ajax -->
    <things-ajax id="auto-region-assign-ajax" resource-url="order_preprocesses/:id/assign/equip_level"
      resource-id="[[batchId]]" resource-action="update">
    </things-ajax>

    <!-- 주문 가공 데이터 완료 Ajax -->
    <things-ajax id="complete-preprocessing-ajax" resource-url="order_preprocesses/:id/complete_preprocess"
      resource-action="update">
    </things-ajax>

    <!-- 주문 가공 데이터 Cell 바꾸기 Ajax -->
    <things-ajax id="swap-cell-ajax" resource-url="order_preprocesses/:id/swap_cell" resource-action="update">
    </things-ajax>

    <!-- 반품 가공 화면 컨테이너 -->
    <div class="container">
      <!-- 검색 폼 -->
      <things-search-form id="search-form" class="margin-zero" title="[[menuInfo.title]]"
        form-fields="[[searchFormFields]]" select-fields="[[selectFields]]" sort-fields="[[sortFields]]"
        action-url="[[menuInfo.resource_url]]" page="{{page}}" limit="{{limit}}" last-response="{{lastResponse}}">
      </things-search-form>

      <!-- 상단 우측 서머리 그리드 -->
      <things-resource-grid id="summary-grid" class="padding-zero" config="[[sumGridConfig]]" model="[[sumGridModel]]"
        columns="[[sumGridColumns]]" fixed-column-count="0" data="[[summaryData]]" buttons="[[emptyButtons]]">
      </things-resource-grid>

      <!-- 우측 호기 서머리 그리드 -->
      <things-resource-grid id="region-grid" class="padding-zero" config="[[gridConfig]]"
        model="[[gridModel]]" columns="[[gridColumns]]" data="[[regionItems]]" fixed-column-count="[[menuInfo.fixed_columns]]"
        buttons="[[emptyButtons]]">
      </things-resource-grid>

      <!-- 좌측 상품별 서머리 그리드 -->
      <things-resource-grid id="grid" class="padding-zero" config="[[gridConfig]]" model="[[gridModel]]"
        columns="[[gridColumns]]" data="[[items]]" fixed-column-count="[[menuInfo.fixed_columns]]"
        grid-save-action="[[menuInfo.grid_save_url]]" buttons="[[emptyButtons]]" export-file-name="[[menuInfo.title]]"
        export-sheet-name="[[menuInfo.title]]">
      </things-resource-grid>
    </div>

    <paper-toolbar>
      <!-- 하단 버튼 그룹 -->
      <div class="bottom">
        <things-button-bar id="button-group" buttons="[[buttons]]"></things-button-bar>
      </div>
    </paper-toolbar>
  </template>

  <script>
    Polymer({
      is: 'sms-preprocess',

      behaviors: [
        Things.ResourceMenuContentBehavior
      ],

      properties: {
        /**
         * 현재 배치 아이디
         ***************
         * @type {String}
         */
        batchId: {
          type: String
        },

        /**
         * 선택된 호기 코드
         ***************
         * @type {String}
         */
        selectRegion: {
          type: String
        },

        /**
         * 선택된 주문 그룹 코드
         ***************
         * @type {String}
         */
        selectGroup: {
          type: String
        },

        /**
         * 서머리 그리드 데이터
         ***************
         * @type {Array}
         */
        summaryData: {
          type: Array
        },

        /**
         * 호기 그리드 데이터
         ***************
         * @type {Array}
         */
        regionItems: {
          type: Array
        },

        /**
         * 빈 버튼
         ***************
         * @type {Array}
         */
        emptyButtons: {
          type: Array,
          value: function () {
            return [];
          }
        },

        /**
         * 그리드 설정
         ***************
         * @type {Object}
         */
        gridConfig: {
          type: Object,
          value: function () {
            return {
              options: {
                edit: {
                  editable: false,
                  pasteEnabled: false
                },
                display: {
                  fitStyle: 'fill'
                },
                checkBar: {
                  exclusive: true
                }
              }
            };
          }
        },

        /**
         * 서머리 그리드 설정
         ***************
         * @type {Object}
         */
        sumGridConfig: {
          type: Object,
          value: function () {
            return {
              options: {
                edit: {
                  editable: false,
                  pasteEnabled: false
                },
                rowIndicator: {
                  visible: false
                },
                checkBar: {
                  visible: false
                }
              },
              displayOptions: {
                fitStyle: 'evenFill'
              }
            }
          }
        },

        /**
         * 서머리 그리드 설정
         ***************
         * @type {Array}
         */
        sumGridModel: {
          type: Array,
          value: function () {
            return [{
              fieldName: 'shop_qty', dataType: 'number'
            }, {
              fieldName: 'assigned_cust', dataType: 'number'
            }, {
              fieldName: 'remain_cust', dataType: 'number'
            }, {
              fieldName: 'total_orders_pcs', dataType: 'number'
            }, {
              fieldName: 'assigned_pcs', dataType: 'number'
            }, {
              fieldName: 'remain_pcs', dataType: 'number'
            }];
          }
        },

        /**
         * 서머리 그리드 설정
         ***************
         * @type {Array}
         */
        sumGridColumns: {
          type: Array,
          value: function () {
            return [{
              name: 'shop_qty',
              fieldName: 'shop_qty',
              width: 60,
              header: {
                text: Things.DataGlobal.t('label.shop_qty')
              },
              styles: {
                textAlignment: 'far', numberFormat: '0,000'
              },
              editable: false
            }, {
              name: 'assigned_cust',
              fieldName: 'assigned_cust',
              width: 60,
              header: {
                text: Things.DataGlobal.t('label.assigned_cust')
              },
              styles: {
                textAlignment: 'far', numberFormat: '0,000'
              },
              editable: false
            }, {
              name: 'remain_cust',
              fieldName: 'remain_cust',
              width: 60,
              header: {
                text: Things.DataGlobal.t('label.remain_cust')
              },
              styles: {
                textAlignment: 'far', numberFormat: '0,000'
              },
              editable: false
            }, {
              name: 'total_orders_pcs',
              fieldName: 'total_orders_pcs',
              width: 60,
              header: {
                text: Things.DataGlobal.t('label.total_pcs')
              },
              styles: {
                textAlignment: 'far', numberFormat: '0,000'
              },
              editable: false
            }, {
              name: 'assigned_pcs',
              fieldName: 'assigned_pcs',
              width: 60,
              header: {
                text: Things.DataGlobal.t('label.assigned_pcs')
              },
              styles: {
                textAlignment: 'far', numberFormat: '0,000'
              },
              editable: false
            }, {
              name: 'remain_pcs',
              fieldName: 'remain_pcs',
              width: 60,
              header: {
                text: Things.DataGlobal.t('label.remain_pcs')
              },
              styles: {
                textAlignment: 'far', numberFormat: '0,000'
              },
              editable: false
            }];
          }
        },
      },

      observers: [
        '_searchDataChanged(lastResponse)'
      ],

      listeners: {
        'things-grid-configured': '_gridConfigured',

        'button-group.back-btn-tap': 'goBack',
        'button-group.auto_assign-btn-tap': 'autoAssignment',
        'button-group.swap-btn-tap': 'popupSwapView',
        'button-group.end_preprocess-btn-tap': 'completePreprocessing',

        'search-form.things-form-submit-configured': '_onSearchFormBeforeSubmit',

        'search-preprocessing-ajax.things-ajax-response': '_preprocessListChanged',
        'auto-region-assign-ajax.things-ajax-response': 'refreshData',
        'swap-cell-ajax.things-ajax-response': 'refreshData',
        'complete-preprocessing-ajax.things-ajax-response': '_preprocessingCompleted',
        'instruct-jobs-ajax.things-ajax-response': 'goBack'
      },

      /**
       * Ready
       */
      ready: function () {
        this.limit = 100000;
      },

      /**
       * 그리드 구성 후 처리
       **************
       * @param {Object} e
       */
      _gridConfigured: function (e) {
        e.target.grid.autoFill().setEnabled(false);

        // 아이디로 그리드를 찾아 개별 설정
        switch (e.target.id) {
          // 호기 그리드의 [ALL]행과 빈 행은 체크할 필요 없음
          case 'region-grid': {
            e.target.grid.checkBar().setHideUncheckable(true);
          }
        }
      },

      /**
       * 폼 서브밋 전에 서버 호출에 불필요한 query 파라미터를 제거
       **************
       * @param {Object} event
       */
      _onSearchFormBeforeSubmit: function (event) {
        var form = event.detail;
        var query = form.request.params.query;
        var queryArr = (typeof (query) == 'string') ? JSON.parse(query) : query ? query : [];
        var realQuery = queryArr.filter(function (query) {
          //          return (query.name == 'batch_id' || query.name == 'rack_cd');
          return (query.name == 'id');
        });
        form.request.params.query = JSON.stringify(realQuery);

        this.batchId = this._getCurrentBatchId();
      },

      /**
       * 현재 설정된 배치 ID
       **************
       * @return {String} 현재 설정된 배치 ID
       */
      _getCurrentBatchId: function () {
        var searchForm = this.getResourceSearchForm();
        var formData = searchForm.serializeMyForm();
        return formData.id;
      },

      /**
       * 주문 가공 정보가 변경된 경우
       **************
       * @param {Object} event
       */
      _preprocessListChanged: function (event) {
        this.items = event.detail.items;
      },

      /**
       * 주문 가공 데이터 가공
       **************
       * @param {Array} items
       */
      _preprocessItemsChanged: function (items) {
        if (items && items.length > 0) {
          this.items = items.map(function (item) {
            item.sku_nm = '(' + item.sku_cd + ') ' + item.sku_nm;
            return item;
          });
        } else {
          this.items = [];
        }

        this.$['search-form'].setFormData({ id: this.batchId });
      },

      /**
       * 뒤로 이동
       **************
       * @param {Object} e 버튼 탭 이벤트
       */
      goBack: function (e) {
        page('/sms_job_batches', {});
      },

      /**
       * 자동 할당 버튼 이벤트 핸들러
       **************
       * @param {Object} e 버튼 탭 이벤트
       */
      autoAssignment: function (e) {
        // 1. 현재 배치 작업 상태 체크
        if (!this._checkTransactionEnabled()) return;

        // 서버에 자동할당 요청
        var params = { auto_assign: true };
        var title = Things.DataGlobal.t(event.detail.text);
        this._confirmTransaction('auto-region-assign-ajax', title, params, this.items);
      },

      /**
       * 로케이션 바꾸기 팝업 표시
       ********************
       */
      popupSwapView: function () {
        var leftCheckedRows = this._checkedGridRows(this.$['grid'], Things.DataGlobal.t('label.region'), true);
        var rightCheckedRows = this._checkedGridRows(this.$['region-grid'], Things.DataGlobal.t('label.region'), true);

        if (leftCheckedRows && rightCheckedRows) {
          var leftSelectedRow = leftCheckedRows[0];
          var rightSelectedRow = rightCheckedRows[0];

          var params = {
            batch_id: this.batchId,
            prev_id: leftSelectedRow.id,
            current_id: rightSelectedRow.id,
            prev_chute_no: leftSelectedRow.sub_equip_cd,
            current_chute_no: rightSelectedRow.sub_equip_cd,
            prev_cell_cd: leftSelectedRow.class_cd,
            current_cell_cd: rightSelectedRow.class_cd
          };
          var title = Things.DataGlobal.t(event.detail.text);
          this._confirmTransaction('swap-cell-ajax', title, '', params);
          /**
          * swap 서비스 생성 또는 기존 서비스 수정
          * sql1 = update order_preprocesses set sub_equip_cd = :current_chute_no where batch_id = :batch_id and sub_equip_cd = :prev_chute_no and cell_assgn_cd = :prev_shop_cd;
          * sql2 = update order_preprocesses set sub_equip_cd = :prev_chute_no where batch_id = :batch_id and sub_equip_cd = :current_chute_no and cell_assgn_cd = :current_shop_cd;
          */
        }
      },

      /**
       * 주문 가공을 완료한다.
       **************
       * @param {Object} e 버튼 탭 이벤트
       */
      completePreprocessing: function (e) {
        if (!this._checkTransactionEnabled()) return;

        var batchId = this.batchId;

        var title = Things.DataGlobal.t('button.end_preprocess');
        var ajax = this.$['complete-preprocessing-ajax'];
        var text = Things.DataGlobal.t('text.Sure to X', { x: title });

        this.openConfirmMsg({
          type: 'info', title: title, text: text, showCancelButton: true
        }, function () {
          ajax.resourceUrl = 'order_preprocesses/' + batchId + '/complete_preprocess';
          ajax.generateRequest();
        });
      },

      /**
       * 트랜잭션 확인 후 실행
       ****************
       * @param {String} ajaxId Ajax Id
       * @param {String} title 트랜잭션 확인용 타이틀
       * @param {Object} params ajax 호출용 파라미터
       * @param {Object} bodyObj ajax 호출용 body 파라미터
       */
      _confirmTransaction: function (ajaxId, title, params, bodyObj) {
        if (!this._checkTransactionEnabled()) return;

        var batchId = this.batchId;
        if (batchId) {
          var ajax = this.$[ajaxId];
          if (params) ajax.params = params;
          if (bodyObj) ajax.body = bodyObj;

          var text = Things.DataGlobal.t('text.Sure to X', { x: title });
          this.openConfirmMsg({
            type: 'info', title: title, text: text, showCancelButton: true
          }, function () {
            ajax.resourceId = batchId;
            ajax.generateRequest();
          });
        } else {
          var text = Things.DataGlobal.t('text.no_batch_id');
          this.openInfoMsg({ type: 'info', title: text, closeOnConfirm: true });
        }
      },

      /**
       * 조회 데이터 변경시
       ****************
       * @param {Object} lastResponse
       */
      _searchDataChanged: function (lastResponse) {
        if (lastResponse) {
          var sumGridNoData = function (sumGridModel) {
            let r = {};
            for (let i = 0, n = sumGridModel.length; i < n; i++) {
              r[sumGridModel[i].fieldName] = 0;
            }
            return [r];
          }
          this.summaryData = lastResponse.summary && lastResponse.summary[0] ? lastResponse.summary : sumGridNoData(this.sumGridModel);

          var regionItems = lastResponse.regions;
          regionItems = (regionItems && regionItems.length > 0) ? regionItems : [];
          var totalAssignedPcs = 0;

          regionItems.forEach(function (item) {
            totalAssignedPcs += isNaN(item.assigned_pcs) ? 0 : item.assigned_pcs;
          });

          this.regionItems = regionItems;

          this._preprocessItemsChanged(lastResponse.preprocesses);
        }
      },

      /**
       * 그리드에서 체크된 Row의 데이터를 리턴
       *****************
       * @param {Object} grid 체크할 그리드
       * @param {String} gridTitle 그리드 타이틀
       * @param {Boolean} showMessage 그리드에 체크된 항목이 없으면 메시지 표시 여부
       * @return 그리드에서 체크된 리스트
       */
      _checkedGridRows: function (grid, gridTitle, showMessage) {
        var rows = grid.getGridObject().getCheckedRows();

        if (rows && rows.length > 0) {
          var ds = grid.getGridDataSet();
          return rows.map(function (row) {
            return ds.getRowObject(row.dataIndex());
          });

        } else {
          if (showMessage) {
            this.openInfoMsg({
              type: 'info',
              title: Things.DataGlobal.t('title.info'),
              text: Things.DataGlobal.t('text.please_select_items_in_x_grid', { x: gridTitle }),
              closeOnConfirm: true
            });
          }

          return null;
        }
      },

      /**
       * 트랜잭션 처리 가능한 지 여부 체크
       *****************
       * @param {String} buttonId
       * @return {Boolean} 작업 처리 가능 여부
       */
      _checkTransactionEnabled: function (buttonId) {
        var formData = this.$['search-form'].serializeMyForm();
        var status = formData['status'];

        if (status == 'END') {
          this.openInfoMsg({ type: 'info', title: Things.DataGlobal.t('text.already_complete') });
          return false;
        }

        if (status == 'RUN') {
          this.openInfoMsg({ type: 'info', title: Things.DataGlobal.t('text.already_running') });
          return false;
        }

        return true;
      },


      /**
       * 주문 가공 완료 처리 후
       **************
       * @param {Object} event
       */
      _preprocessingCompleted: function (event) {
        var batchList = event.detail;
        if (!batchList || batchList.length == 0) return;
        var firstBatch = batchList[0];

        // 1. 작업 유형이 RTN3 인지 체크
        if (firstBatch.job_type != 'RTN') {
          this.goBack();

          // 2. 사용자에게 작업지시까지 처리할 건지 물어보고
        } else {
          this.openConfirmMsg({
            type: 'info',
            title: Things.DataGlobal.t('title.confirm'),
            text: Things.DataGlobal.t('text.Sure to X', { x: Things.DataGlobal.t('button.job_instruct') }),
            showCancelButton: true

          }, function () {
            var ajax = this.$['instruct-jobs-ajax'];
            ajax.body = batchList;
            ajax.generateRequest();

          }.bind(this), function () {
            this.goBack();
          }.bind(this));
        }
      },


    });
  </script>
</dom-module>