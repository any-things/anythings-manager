<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-resizable-behavior/iron-resizable-behavior.html">

<script src="../../bower_components/things-scene-core/things-scene-min.js"></script>
<script src="../../bower_components/things-scene-form/things-scene-form-min.js"></script>

<!--script src="../../bower_components/things-scene-conveyor/things-scene-wheel-sorter-min.js"></script>
<script src="../../bower_components/things-scene-indoor-map/things-scene-indoor-map-min.js"></script>
<script src="../../bower_components/things-scene-tab/things-scene-tab-min.js"></script>
<script src="../../bower_components/things-scene-table/things-scene-table-min.js"></script>
<script src="../../bower_components/things-scene-progressbar/things-scene-progressbar-min.js"></script>

<script src="./asset/sorter-status-control-model.js"></script-->
<script src="./asset/sorter-status-test-model.js"></script>
<link rel="import" href="./rack-cell-popup.html">
<link rel="import" href="./work-group-popup.html">

<dom-module id="sms-control">
  <template>
    <style>
      :host {
        display: block;
        background-color: #434854;
      }

      .bottom {
        position: absolute;
        bottom: 10px;
        right: 10px;
        z-index: 1;
      }
    </style>

    <things-ajax id="chute-status" resource-action="find" resource-url="diy_services/sorter_status_monitor/read.json"
      last-response="{{chuteStatusResponse}}">
    </things-ajax>

    <!-- 주문 가공 데이터 조회 Ajax -->
    <things-ajax id="chute-select-ajax" resource-url="chutes" resource-action="index">
    </things-ajax>

    <things-ajax id="generate-order-ajax" resource-url="order_preprocesses/generate_order" method="POST"
      content-type="application/json">
    </things-ajax>

    <div class="bottom">
      <things-button-bar id="button-group" buttons="[[customButtons]]"></things-button-bar>
    </div>
  </template>

  <script>
    Polymer({
      is: 'sms-control',

      behaviors: [
        Polymer.IronResizableBehavior
      ],

      properties: {
        scene: {
          type: Object,
          notify: true
        },

        jobBatch: {
          type: Object,
        },

        model: {
          type: Object
        },

        chuteCellCnt: {
          type: Object
        },

        chuteStatusResponse: {
          type: Object,
          observer: '_onChuteStatusResponse'
        },

        customButtons: {
          type: Array,
          value: [{
            id: 'complete-btn',
            text: 'complete'
          }]
        }
      },

      listeners: {
        'iron-resize': '_onIronResize',
        'complete-btn-tap': '_completeBtnTap',
        'chute-select-ajax.things-ajax-response': '_chuteSelectResponse',
        'generate-order-ajax.things-ajax-response': '_generateCompleted'
      },

      observers: [
        "_onModelChanged(model)"
      ],

      attached() {
        this.model = SORTER_STATUS_MONITOR_MODEL;
        document.addEventListener('things-routing-changed-sms_control', this._onRouteChanged.bind(this));

        // Event Binding
        this.scene.on('click', this._onSceneClick, this)
      },

      detached() {
        if (this.scene)
          this._disposeScene()
      },

      _onRouteChanged(route) {
        this.jobBatch = route.detail.initialParams;
        let chuteStatus = this.$['chute-select-ajax'];
        chuteStatus.generateRequest();
      },

      /**
       * 주문 가공 정보가 변경된 경우
       **************
       * @param {Object} event
       */
      _chuteSelectResponse: function (event) {
        this.chuteStatusResponse = event.detail.items;
      },

      // 데이터 리스폰 시, 화면 데이터 세팅
      _onChuteStatusResponse(response) {
        let data = {};
        this.chuteCellCnt = {};

        response.forEach(v => {
          if (v.chute_no) {
            if(v.active_flag && v.status == 'W') {
              data['chute-' + v.chute_no] = 'Y';
            } else {
              data['chute-' + v.chute_no] = 'N';
            }

            if(v.ext_flag) {
              this.chuteCellCnt[v.chute_no + '-ext_cell_cnt'] = v.ext_cell_cnt;
            } else {
              this.chuteCellCnt[v.chute_no + '-ext_cell_cnt'] = 0;
            }
          }
        });
        this.scene.data = data;
        console.log(this.scene.data);
      },

      _disposeScene() {
        if (this.scene) {
          this.scene.off('mode', this._onSceneModeChanged, this);
          this.provider ? this.scene.release() : this.scene.dispose();
          this.scene = null;
        }
      },

      _onSceneClick(e, hint) {
        var origin = hint.origin
        var id = origin.get('id')
        var type = origin.get('type')

        if (id && (type == 'local-ref' && id.indexOf('chute') != -1) || (type == 'local-ref' && id.indexOf('input') != -1)) {
          var state = origin.data
          origin.data = state == 'Y' ? 'N' : 'Y'
        }
      },

      _onIronResize(e) {
        if (this.scene) {
          this.scene.resize();
          if (this.offsetWidth) {
            this._fit();
          }
        }
      },

      _fit() {
        if (!this.scene)
          return;
        this.scene.fit('both');
      },

      _onModelChanged(model) {
        this._disposeScene();

        if (!model)
          return;

        this.scene = scene.create({
          target: this,
          model: model,
          mode: 0 /* mode 0 : view mode, mode 1 : edit mode, mode 2 : shift mode */
        });

        /* 이 컴포넌트의 폭이 값을 가지고 있으면 - 화면상에 자리를 잡고 보여지고 있음을 의미한다.
         * 이 때는 정상적으로 그려주고,
         * 그렇지 않으면, 다음 Resize Handling시에 처리하도록 한다.
         */
        if (this.offsetWidth)
          this._fit();
      },

      _completeBtnTap() {
        let chuteStatusSet = this.$['generate-order-ajax'];
        chuteStatusSet.body = {
          chuteStatus: this.scene.data,
          batchId: this.jobBatch.id
        };

        chuteStatusSet.generateRequest();
      },

      /**
       * 주문 generate 완료 처리 후
       **************
       * @param {Object} event
       */
      _generateCompleted: function (event) {
        if(event.detail > 0 ) {
          var routing = '/sms_preprocess';
          page(routing, this.jobBatch)
        } else {
          this.openInfoMsg({
            title: Things.DataGlobal.t('label.failure'),
            type: 'info',
            text: Things.DataGlobal.t('text.Fail to Process'),
            closeOnConfirm: true
          });
        }
      }
    });
  </script>
</dom-module>