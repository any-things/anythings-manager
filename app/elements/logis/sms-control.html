<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-resizable-behavior/iron-resizable-behavior.html">

<script src="../../bower_components/things-scene-core/things-scene-min.js"></script>
<script src="../../bower_components/things-scene-form/things-scene-form-min.js"></script>

<script src="../../bower_components/things-scene-conveyor/things-scene-wheel-sorter-min.js"></script>
<script src="../../bower_components/things-scene-indoor-map/things-scene-indoor-map-min.js"></script>
<script src="../../bower_components/things-scene-tab/things-scene-tab-min.js"></script>
<script src="../../bower_components/things-scene-table/things-scene-table-min.js"></script>
<script src="../../bower_components/things-scene-progressbar/things-scene-progressbar-min.js"></script>

<script src="./asset/sorter-status-control-model.js"></script>
<script src="./asset/sorter-status-test-model.js"></script>
<link rel="import" href="./rack-cell-popup.html">

<dom-module id="sms-control">
  <template>
    <style>
      :host {
        display: block;
        background-color: #434854;
      }

      .bottom {
        position: absolute;
        bottom: 10px;
        right: 10px;
        z-index: 1;
      }
    </style>

    <things-ajax id="chute-status" resource-action="find" resource-url="diy_services/sorter_status_monitor/read.json"
      last-response="{{chuteStatusResponse}}">
    </things-ajax>

    <things-ajax id="chute-status-set" resource-url="chute/sorter_status_monitor_set" method="POST"
      content-type="application/json">
    </things-ajax>

      <div id='sort_group_001'class="popup_title">호기
      <ul id="mps_sort_group">
      </ul>
      </div>

    <div class="bottom">
      <things-button-bar id="button-group" buttons="[[customButtons]]"></things-button-bar>
    </div>
  </template>

  <script>
    Polymer({
      is: 'sms-control',

      behaviors: [
        Polymer.IronResizableBehavior
      ],

      properties: {
        scene: {
          type: Object,
          notify: true
        },

        popup: {
          type: Object
        },

        model: {
          type: Object
        },

        chuteStatusResponse: {
          type: Object,
          observer: '_onChuteStatusResponse'
        },

        customButtons: {
          type: Array,
          value: [{
            id: 'complete-btn',
            text: 'complete'
          }]
        }
      },

      listeners: {
        'iron-resize': '_onIronResize',
        'complete-btn-tap': '_completeBtnTap'
      },

      observers: [
        "_onModelChanged(model)"
      ],

      attached() {
        this.model = SORTER_STATUS_MONITOR_MODEL;
        // this.model = SORTER_STATUS_TEST_MODEL;
        document.addEventListener('things-routing-changed-sms_control', this._onRouteChanged.bind(this));

        // Event Binding
        this.scene.on('click', this._onSceneClick, this)
      },

      detached() {
        if (this.scene)
          this._disposeScene()
      },

      _onRouteChanged(route) {
        let chuteStatus = this.$['chute-status'];
        // chuteStatus.generateRequest();
      },

      // 데이터 리스폰 시, 화면 데이터 세팅
      _onChuteStatusResponse(response) {

        // Data Setting
        let data = {};
        let distributionMethod;
        let delayTime;

        response.forEach(v => {
          if (v.o_key.indexOf('chute') != -1) {
            data[v.o_key] = v.o_value;
          } else if (v.o_key.indexOf('eta') != -1) {
            data[v.o_key] = v.o_value == 'Y' ? 1 : 0;
          } else if (v.o_key == 'sorter_type') {
            // 서버에서 오는 분배 종류 = IN_ORDER, EQUALLY
            data['selectChute'] = distributionMethod = v.o_value;
          } else if (v.o_key == 'delay_time') {
            data['selectDelay'] = delayTime = v.o_value;
          }
        });

        let selectChute = this.scene.findById('selectChute')
        selectChute.set('value', distributionMethod);

        let selectDelay = this.scene.findById('selectDelay')
        selectDelay.set('value', delayTime);

        this.scene.data = data;
      },

      _disposeScene() {
        if (this.scene) {
          this.scene.off('mode', this._onSceneModeChanged, this);
          this.provider ? this.scene.release() : this.scene.dispose();
          this.scene = null;
        }
      },

      _onSceneClick(e, hint) {

        if(this.popup)
          this.popup.remove();



        var origin = hint.origin
        var id = origin.get('id')
        var type = origin.get('type')

        if ((type == 'local-ref' && id.indexOf('chute') != -1) || (type == 'local-ref' && id.indexOf('input') != -1)) {
          var state = origin.data
          origin.data = state == 'Y' ? 'N' : 'Y'
        } else if(type == 'rect' && id.indexOf('op_mps') != -1) {
          this.createGroupPopup();
        }
      },

      _onIronResize(e) {
        if (this.scene) {
          this.scene.resize();
          if (this.offsetWidth) {
            this._fit();
          }
        }
      },

      _fit() {
        if (!this.scene)
          return;
        this.scene.fit('both');
      },

      _onModelChanged(model) {
        this._disposeScene();

        if (!model)
          return;

        this.scene = scene.create({
          target: this,
          model: model,
          mode: 0 /* mode 0 : view mode, mode 1 : edit mode, mode 2 : shift mode */
        });

        /* 이 컴포넌트의 폭이 값을 가지고 있으면 - 화면상에 자리를 잡고 보여지고 있음을 의미한다.
         * 이 때는 정상적으로 그려주고,
         * 그렇지 않으면, 다음 Resize Handling시에 처리하도록 한다.
         */
        if (this.offsetWidth)
          this._fit();
      },

      _completeBtnTap() {
        let chuteStatusSet = this.$['chute-status-set'];
        chuteStatusSet.body = {
          data: this.scene.data
        };

        chuteStatusSet.generateRequest();
      },

      /**
      * 작업그룹을 다이얼로그를 생성하여 리턴
      * ***********************
      * @param {String} batchId
      * @return 주문 가공 완료 팝업 화면
      */
      createGroupPopup: function () {
        this.popup = this.$['sort_group_001'];
        var groupUl = this.popup.children.mps_sort_group;
        groupUl.innerHTML = "<li id=test>asdfasdfasdfasd</li>";
        

        this.popup.style.marginLeft = '150px';
        this.popup.style.marginTop = '200px';


      }
    });
  </script>
</dom-module>