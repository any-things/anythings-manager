<!--
@license
Copyright © HatioLab Inc. All rights reserved.
-->
<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/things-ajax/things-ajax.html">
<link rel="import" href="../../bower_components/things-form/things-search-form.html">
<link rel="import" href="../../bower_components/things-grid/things-resource-grid.html">

<link rel="import" href="../../bower_components/things-content/things-resource-menu-content-behavior.html">

<!--
	주문 및 작업 > 작업 내역
-->

<dom-module id="job-result">
	<template>
		<style>
		:host {
        @apply(--layout-flex);
        @apply(--layout-vertical);
      }
      .grid-container {
        @apply(--layout-flex);
        display: grid;
        grid-template-rows: auto 40%;
      }
		</style>

		<things-ajax
			auto
			id="resource-meta"
			method="GET"
			resource-url="[[menuMetaUrl]]"
			last-response="{{metaData}}">
    </things-ajax>

    <!-- Data Ajax -->
    <things-ajax
      id="sku-ajax"
      resource-url="diy_services/job-result-detail/read.json"
      resource-action="get"
      last-response="{{skuData}}">
    </things-ajax>

		<things-search-form
			id="search-form"
			title="[[menuInfo.title]]"
			form-fields="[[searchFormFields]]"
			select-fields="[[selectFields]]"
			sort-fields="[[sortFields]]"
			action-url="[[menuInfo.resource_url]]"
			page="{{page}}"
			limit="{{limit}}"
			last-response="{{lastResponse}}">
		</things-search-form>

    <div class="grid-container">
			<things-resource-grid
				id="job-grid"
				config="[[gridConfig]]"
				model="[[gridModel]]"
				columns="[[gridColumns]]"
				data="[[items]]"
				total-count="[[itemCount]]"
				current-page="{{page}}"
				limit="{{limit}}"
				buttons="[[buttons]]"
				paginatable
				show-paginator
				fixed-column-count="[[menuInfo.fixed_columns]]"
				buttons="[[emptyButtons]]">
			</things-resource-grid>

			<things-resource-grid
				id="sku-grid"
				model="[[jobResultSkuGridModel]]"
	      columns="[[jobResultSkuGridColumns]]"
	      fixed-column-count="0"
	      data="[[skuData]]"
	      total-count="[[skuData.length]]"
				buttons="[[emptyButtons]]">
	    </things-resource-grid>
  	</div>
	</template>

	<script>
		Polymer({
			is: 'job-result',

			behaviors: [
				Things.MenuGridContentBehavior
			],

			properties: {
				/**
				 * 메뉴 ID
				 */
				menuId: {
					type: String
				},

				/**
				 * 상세 화면 구성을 위해 필요한 메뉴 메타 데이터를 조회하기 위한 URL
				 */
				menuDetailMetaUrl: {
					type: String,
					computed: '_computeMenuDetailMetaUrl(menuId)',
					observer: '_invokeDetailMetaData'
				},

				/**
				 * 마스터 데이터를 마스터 그리드에 표시할 select 필드
				 */
				masterSelectFields: {
					type: String
				},

				/**
				 * 메뉴 Detail 화면 구성을 위한 메타 데이터
				 */
				detailMetaData: {
					type: Array,
					observer: '_parseDetailMetaData'
				},

				/**
				 * 빈 버튼
				 */
        emptyButtons: {
          type: Array,
          value: function() {
            return []
          }
        }
			},

			listeners: {
        'job-grid.things-grid-row-data-select': '_getSkuData',
        'job-grid.things-grid-column-dblclicked': '_showExceptionDialog'
			},

			observers: [
				'_gridColumnsChanged(gridColumns)'
			],

			/**
 			 * 마스터 그리드 컬럼이 변경된 이후
 			 * @param {Object} gridColumns 그리드 컬럼
 			 *********
			 */
			_gridColumnsChanged: function(gridColumns) {
				var selectColumns = '';

				gridColumns.forEach(function(metaData) {
					if(!metaData.virtual_field || metaData.virtual_field == false) {
						selectColumns += metaData.name + ',';
					}
				});

				if(selectColumns.length > 2) {
					this.masterSelectFields = selectColumns.substr(0, selectColumns.length - 1);
				}
			},

			/**
 			 * 메뉴 디테일 메타 정보 조회
 			 * @param {String} menuDetailMetaUrl
 			 *********
			 */
			_invokeDetailMetaData: function(menuDetailMetaUrl) {
				var detailMetaAjax = document.createElement('things-ajax');
				detailMetaAjax.resourceId = this.menuId;
				detailMetaAjax.resourceUrl = menuDetailMetaUrl;
				detailMetaAjax.addEventListener('things-ajax-response', function(event) {
					this.detailMetaData = event.detail;
				}.bind(this));

				detailMetaAjax.generateRequest();
			},

			/**
			 * menuId로 부터 메뉴 상세 메타 데이터 조회를 위한 URL을 생성
			 * *******
			 * @param {String} menuId 메뉴 아이디
			 * @return {String} 메뉴 상세 메타 데이터 조회를 위한 URL
			 */
			_computeMenuDetailMetaUrl: function(menuId) {
				return 'menu_details/' + menuId + '/meta';
			},

			/**
			 * 서버로 부터 응답받은 메뉴 상세에 대한 메타 데이터를 상세 화면 구성을 위해 필요한 메타 데이터로 변환한다.
			 * *******
			 * @param {Array} detailMetaList 서버로 부터 응답받은 메뉴 상세에 대한 메타 데이터
			 */
       _parseDetailMetaData: function(detailMetaList) {
				if(!detailMetaList || detailMetaList.length == 0) {
					return;
				}

				for(var i = 0 ; i < detailMetaList.length ; i++) {
					var metaData = detailMetaList[i];

					if(metaData.association != 'one-to-many') {
						continue;
					}

          this[metaData.name + 'Title'] = metaData.name;
          this[metaData.name + 'SearchUrl'] = metaData.search_url;
          this[metaData.name + 'SaveUrl'] = metaData.save_url;
          this[metaData.name + 'Field'] = metaData.master_field;

					if(metaData.menu_detail_buttons) {
						var buttons = this._parseButtons(metaData.menu_detail_buttons);
						if(buttons && buttons.length > 0) {
							buttons.forEach(function(button) { button.id = button.name + '-btn'; });
						}

            this[metaData.name + 'Buttons'] = buttons;
					}

					if(metaData.menu_detail_columns) {
						// Parse Grid Models - Grid
            this[metaData.name + 'GridModel'] = this._parseGridModel(metaData.menu_detail_columns);

						// Parse Grid Columns - Grid
            this[metaData.name + 'GridColumns'] = this._parseGridColumns(metaData.menu_detail_columns)
					}
				}

				this.fire('detail-meta-data-configured');
			},

			/**
			 * 마스터 데이터 조회
			 * *******
			 * @param {Object} event
			 */
			refreshMaster: function(event) {
				this.$['search-form'].submitMyForm();
			},

      /**
    	 * Override
    	 *****************
    	 */
       _responseChanged: function(lastResponse) {
        this.items = (this.itemsProp && lastResponse[this.itemsProp]) ? lastResponse[this.itemsProp] : lastResponse;
    		this.itemCount = (this.totalProp && lastResponse[this.totalProp]) ? lastResponse[this.totalProp] : lastResponse.length;
      },

      /**
    	 * Override
    	 *****************
    	 */
      refreshData: function() {
    		if(!this.initialSearchFlag) {
    			this.initialSearchFlag = true;
    		}
    	},

      /**
       * job-grid row-data-select event handler
       * 선택한 row의 job_id를 통해 sku-ajax의 parameter를 세팅
       * sku-ajax 호출을 통해 skuData 조회
			 * @param {Object} event
			 ************
       */
      _getSkuData: function(event) {
        var resource = event.detail;
        if(!resource.invoice_id) return;

        var skuAjax = this.$['sku-ajax'];
        skuAjax.params = {
          invoice_id: resource.invoice_id,
          job_date: resource.job_date,
          job_batch_seq: resource.job_batch_seq
        };
				
        skuAjax.generateRequest();
      },

      /**
       * sku-grid row-data-select event handler
       * 선택한 row의 order_no를 대상으로 예외처리를 진행하기 위한 dialog (job-result-exception)를 open
			 * @param {Object} event
			 *****************
       */
      _showExceptionDialog: function(event) {
        var grid = event.detail.grid;
        var index = event.detail.index;
        var orderId = grid.getRow(index.rowIndex).getRowObject().order_id;
				if(!orderId) return;
				var batchId = grid.getRow(index.rowIndex).getRowObject().batch_id;

        var exceptDialog = document.createElement('job-result-exception');
        exceptDialog.title = Things.DataGlobal.t('title.exception_process');
        exceptDialog.orderId = orderId;
				exceptDialog.batchId = batchId;

        this.fire('things-open-custom-size-dialog', {
          view: exceptDialog,
          modal: true,
          dialogSize: 'small',
          closeCallback: function() {
            this.$['search-form'].submitMyForm();
          }.bind(this)
        });
      }
		});
	</script>
</dom-module>
