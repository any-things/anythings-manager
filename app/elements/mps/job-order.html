<dom-module id="job-order">
	<template>
		<style>
			:host {
				display: block;
				@apply --layout-vertical;
				@apply --layout-flex;
			}

			things-resource-grid {
				@apply --layout-flex;
			}
		</style>

		<things-ajax
			auto
			id="resource-meta"
			method="GET"
			resource-url="[[menuMetaUrl]]"
			last-response="{{metaData}}">
		</things-ajax>

		<things-ajax
			id="check-import-ajax"
			method="POST"
			resource-action="update_multiple"
			content-type="application/json"
			resource-url="[[checkImportUrl]]">
		</things-ajax>

		<things-search-form
			id="search-form"
			form-fields="[[searchFormFields]]"
			select-fields="[[selectFields]]"
			sort-fields="[[sortFields]]"
			action-url="[[menuInfo.resource_url]]"
			page="{{page}}"
			limit="[[limit]]"
			last-response="{{lastResponse}}">
		</things-search-form>

		<things-resource-grid
			id="grid"
			grid-height="[[gridHeight]]"
			auto-filter = "[[autoFilter]]"
			model="[[gridModel]]"
			columns="[[gridColumns]]"
			config="[[gridConfig]]"
			buttons="[[buttons]]"
			current-page="{{page}}"
			limit="{{limit}}"
			data="[[items]]"
			total-count="[[itemCount]]"
			grid-save-action="[[menuInfo.grid_save_url]]"
			fixed-column-count="[[menuInfo.fixed_columns]]"
			export-file-name="[[menuInfo.title]]"
			export-sheet-name="[[menuInfo.title]]"
			diy-template-id="[[menuInfo.diy_template_id]]">
		</things-resource-grid>
	</template>

	<script>
		Polymer({
			is: 'job-order',

			behaviors: [
				Things.MenuGridContentBehavior,
				Things.DetailPopupBehavior,
				Things.ApprSubmitPopupBehavior
			],
			properties: {
				/**
				 * 엑셀 import를 위해 저장 URL에 추가할 경로
				 * 엑셀 import가 아니면 빈값으로 둠
				 * 원래 소스에서 수정을 최소화하기위해 이 방식을 사용
				 */
				additionalPathForImport: {
					type: String,
					value: '/import'
				}
			},
			listeners: {
				'things-grid-import-finished' :'_onImportFinish',
				'check-import-ajax.things-ajax-response' : '_handleCheckImportSuccess',
				'grid.things-grid-handle-build-writedata' : '_handleSetupGridWriteData',
				'grid.update-btn-tap': '_updateBtnTap',
				'grid.things-grid-handle-save' : '_handleSave',
				'grid.things-grid-save-success' : 'showCompleted'
			},
			_onImportFinish: function(e){
				if(!this.items || this.items.length == 0) return;
				var checkImportAjax = this.$['check-import-ajax'];
				checkImportAjax.body = e.detail;
				checkImportAjax.generateRequest();
			},
			/**
			 * Import Check 성공시 액션
			 *
			 * @param {Object} event
			 */
			_handleCheckImportSuccess: function(event) {
				event.preventDefault();
				var items = event.detail;
				// 아이템별 Ready 상태로 변경
				items.forEach(function(item) { item._status_ = 'R'; });
				this.items = items;
				this.checkedForSave = true;
			},
			/**
			 * 저장을 위해 그리드 데이터 셋업
			 *
			 * @param {Object} event
			 */
			_handleSetupGridWriteData: function(event) {
				// event.preventDefault();
			},
			_handleSave: function(event) {
				// 진행 중 메시지 표시
				event.preventDefault();
				this.showProcessing();
				this.writeData = this.$.grid.writeData;
				this.writeData.forEach(function(item){
					item.tran_type ='import'
				});

				try {
					if (!this.writeData || this.writeData.length == 0) {
						this.openInfoMsg({
							title: Things.DataGlobal.t('title.info'),
							text: Things.DataGlobal.t('text.NOTHING_CHANGED'),
							type: 'info'
						});
					} else {
						// this.gridSaveAction = this.gridSaveAction+'/import'
						this.updateMultipleData(`${this.menuInfo.grid_save_url}${this.additionalPathForImport}`);
						this.additionalPathForImport = '/import';
					}
				} catch (err) {
					this.openInfoMsg({
						type: 'error',
						title: err.title ? err.title : Things.DataGlobal.t('error.VALIDATION_ERROR'),
						text: err.message ? err.message : err.toString()
					});
				}
			},
			/**
			 * 처리되고 있음을 표시 ...
			 * ********
			 */
			showProcessing: function(count) {
				this.openInfoMsg({
					title : Things.DataGlobal.t('title.info'),
					text : Things.DataGlobal.t('text.Server Processing'),
					type : 'info'
				});
			},
			/**
			 * 처리완료
			 * *******
			 */
			showCompleted: function() {
				this.openInfoMsg({
					title : Things.DataGlobal.t('title.info'),
					text : Things.DataGlobal.t('text.processed'),
					type : 'info'
				});
			},
			/**
			 * 변경된 데이터(writeData)를 서버에 업데이트 요청한다.
			 * 이 로직을 override하려면 things-grid-handle-save 이벤트를 prevent시키고 별도의 할당 로직을 작성해야 한다.
			 *
			 * @param {String} gridSaveUrl
			 */
			updateMultipleData: function(gridSaveUrl) {
				var ajax = document.createElement('things-ajax');
				if (this.resourceId) ajax.resourceId = this.resourceId;
				ajax.resourceUrl = gridSaveUrl;
				ajax.resourceAction = 'update_multiple';
				ajax.body = this.writeData;
				var me = this;

				ajax.addEventListener('things-ajax-response', function(event) {
					// me.fire('things-grid-save-success', event.detail);
					me.showCompleted();
					me.refreshData();
				});

				ajax.addEventListener('things-ajax-error', function(event) {
					me.fire('things-grid-save-error', event.detail);
				});

				ajax.generateRequest();
			},

			/**
			 * 'update' 버튼을 눌렀을 때 추가 url을 비운다
			 */
			_updateBtnTap: function (event) {
				this.additionalPathForImport = '';
				this.$.grid.saveGridData(event);
			}
		});
	</script>
</dom-module>
