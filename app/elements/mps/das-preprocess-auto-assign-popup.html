<!--
@license
Copyright © HatioLab Inc. All rights reserved.
-->
<link rel="import" href="../../bower_components/polymer/polymer.html">

<!--
  ## das-preprocess-auto-assign-popup
  DAS 주문 가공 자동 할당 팝업
-->

<dom-module id="das-preprocess-auto-assign-popup">
  <template>
    <style>
      :host {
        display: grid;
        grid-template-rows: 1fr auto;
        height: 100%;
      }
      .grid-section {
        display: grid;
        grid-template-columns: 650px auto;
      }
      paper-toolbar {
        height: 50px;
      }
      paper-toolbar::shadow #bottomBar {
        height: 50px;
        @apply(--layout-horizontal);
        @apply(--layout-end-justified);
        padding: 0 10px;
      }
    </style>

    <things-ajax
      auto
      id="das-preprocess-ajax"
      resource-url="das_preprocess/index_all"
      resource-action="index"
      sort-fields="[[sortFields]]"
      last-response="{{summary}}">
    </things-ajax>

    <things-ajax
      id="auto-region-assign-ajax"
      resource-url="das_preprocess/:id/auto_assign/regions"
      resource-id="[[batchId]]"
      resource-action="update">
    </things-ajax>

    <things-ajax
      id="auto-location-assign-ajax"
      resource-url="das_preprocess/:id/auto_assign/locations"
      resource-id="[[batchId]]"
      resource-action="update">
    </things-ajax>

    <div class="grid-section">
      <things-resource-grid
        id="customer-grid"
        model="[[custGridModel]]"
        columns="[[custGridColumns]]"
        buttons="[[emptyButton]]"
        fixed-column-count="0"
        data="[[customerItems]]">
      </things-resource-grid>

      <things-resource-grid
        id="region-grid"
        model="[[regionGridModel]]"
        columns="[[regionGridColumns]]"
        data="[[regionItems]]"
        fixed-column-count="0"
        buttons="[[emptyButton]]">
      </things-resource-grid>
    </div>

    <paper-toolbar>
      <div class="bottom">
        <things-button-bar id="button-group" buttons="[[buttons]]"></things-button-bar>
      </div>
    </paper-toolbar>
  </template>

  <script>
    Polymer({
      is: 'das-preprocess-auto-assign-popup',

      behaviors: [
        Things.MsgBoxBehavior
      ],

      properties: {
       /**
  			 * 그리드 소팅 조건 필드
  			 *****************
  			 * @type {Array}
  			 */
        sortFields: {
          type: Array,
          value: function() {
            return [{
              field: 'order_sku_qty', ascending: false
            }]
          }
        },

        /**
   			 * 빈 버튼
   			 *****************
   			 * @type {Array}
   			 */
        emptyButton: {
          type: Array,
          value: []
        },

        /**
   			 * 버튼 리스트
   			 *****************
   			 * @type {Array}
   			 */
        buttons: {
          type: Array,
          value: [{
            id: 'assign_region',
            text: 'assign_region'
          }, {
            id: 'assign_location',
            text: 'assign_location'
          }]
        },

        /**
   			 * 배치 ID
   			 *****************
   			 * @type {String}
   			 */
        batchId: {
          type: String,
          observer: '_batchIdChanged'
        },

        /**
   			 * 조회 요약 데이터
   			 *****************
   			 * @type {String}
   			 */
        summary: {
          type: Object,
          value: {},
          observer: '_summaryChanged'
        },

        /**
   			 * 호기 그리드 데이터
   			 *****************
   			 * @type {Array}
   			 */
        regionItems: {
          type: Array,
          value: []
        },

        /**
   			 * 거래처 그리드 데이터
   			 *****************
   			 * @type {Array}
   			 */
        customerItems: {
          type: Array,
          value: []
        }
      },

      listeners: {
        'customer-grid.things-grid-configure': '_onGridConfigure',
        'button-group.assign_region-tap': '_autoRegionAssignTapped',
        'button-group.assign_location-tap': '_autoLocationAssignTapped',
        'auto-region-assign-ajax.things-ajax-response': '_autoAssignResponsed',
        'auto-location-assign-ajax.things-ajax-response': '_autoAssignResponsed'
      },

     /**
      * 배치 ID가 변경된 이후
      **************
      * @param {Object} event
      */
      _onGridConfigure: function(event) {
        if(this.custGridColumns) {
          this.custGridColumns.forEach(function(col) {
            if(col.name == 'batch_id') {
              col.width = 0;
            }
          });
        }
      },

      /**
       * 서머리 정보가 변경된 이후
       **************
       * @param {Object} summary
       */
      _summaryChanged: function(summary) {
        this.regionItems = (summary && summary.regions) ? summary.regions : [];
        this.customerItems = (summary && summary.preprocesses) ? summary.preprocesses : [];
      },

     /**
      * 배치 ID가 변경된 이후
      **************
      * @param {String} batchId 배치 ID
      */
      _batchIdChanged: function(batchId) {
        if(batchId) {
          var dasPreprocessAjax = this.$['das-preprocess-ajax'];
          dasPreprocessAjax.queryFields = [{
            name: 'batch_id', operator: 'eq', value: batchId
          }, {
            name: 'region_cd', operator: 'is_blank'
          }];
          dasPreprocessAjax.generateRequest();
        }
      },

      /**
       * 호기 자동 할당 버튼 클릭 핸들러
       **************
       * @param {Object} event 버튼 탭 이벤트
       */
      _autoRegionAssignTapped: function(event) {
        var title = Things.DataGlobal.t('button.assign_region');
        var ajaxId = 'auto-region-assign-ajax';
        this._confirmTransaction(title, ajaxId);
      },

      /**
       * 로케이션 자동 할당 버튼 클릭 핸들러
       **************
       * @param {Object} event 버튼 탭 이벤트
       */
      _autoLocationAssignTapped: function(event) {
        var title = Things.DataGlobal.t('button.assign_location');
        var ajaxId = 'auto-location-assign-ajax';
        this._confirmTransaction(title, ajaxId);
      },

      /**
       * 트랜잭션 확인 및 실행
       **************
       * @param {String} title 트랜잭션 타이틀
       * @param {String} ajaxId ajax 서비스 ID
       */
      _confirmTransaction: function(title, ajaxId) {
        var regionGridObj = this.$['region-grid'].getGridObject();
        var checkedRows = regionGridObj.getCheckedRows();

        if(checkedRows && checkedRows.length > 0) {
          var regionCodes = checkedRows.map(row => row.getRowObject().region_cd);
          regionCodes = regionCodes.join(',');
          var autoAssignAjax = this.$[ajaxId];
          autoAssignAjax.params = { regions: regionCodes };
          autoAssignAjax.body = this.customerItems;
          autoAssignAjax.generateRequest();

        } else {
          this.openInfoMsg({
            type: 'info',
            title: title,
            text: Things.DataGlobal.t('text.VALUE_IS_NOT_EXIST', {
              value: Things.DataGlobal.t('text.selected_x', {
                x: Things.DataGlobal.t('label.region')
              })
            })
          });
        }
      },

      /**
       * 자동 할당 서비스 호출 응답
       **************
       * @param {Object} event
       */
      _autoAssignResponsed: function(event) {
        var self = this;
        this.openConfirmMsg({
          type: 'info',
          title: Things.DataGlobal.t('button.auto_assign'),
          text: Things.DataGlobal.t('text.Success to Process')
        }, function() {
          self.customerItems = event.detail;
        }.bind(this));
      }
    });
  </script>
</dom-module>
