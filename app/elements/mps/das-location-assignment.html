<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/things-ajax/things-ajax.html">
<link rel="import" href="../../bower_components/things-meta/things-named-meta-behavior.html">

<!--
  주문 및 작업 > 주문 가공 > 로케이션 바꾸기 팝업
-->

<dom-module id="das-location-assignment">
   <template>
      <style>
         :host {
            @apply --layout-flex;
            @apply --layout-vertical;
            @apply --things-default-padding;

            --grid-gap: 10px;
         }

         /* 그리드 컨테이너 */
         #container {
            @apply --layout-flex;
            display: grid;
            grid-template:
               "a a" auto
               "b c" auto
               "f g" 57px
               "d e" minmax(120px, 1fr) / minmax(334px, calc(50% - calc(var(--grid-gap) / 2))) minmax(334px, calc(50% - calc(var(--grid-gap) / 2)));
            grid-gap: var(--grid-gap);
         }

         /***** 서치폼 ******/
         #container>#search-form {grid-area: a;}

         /*** 왼쪽 폼 집합 ***/
         #container>#first-select-form-gridarea {grid-area: b;}

         /** 오른쪽 폼 집합 ***/
         #container>#second-select-form-gridarea {grid-area: c;}

         /** 왼쪽 호기 그리드 */
         #container>#first-gridarea {grid-area: d;}

         /* 오른쪽 호기 그리드 */
         #container>#second-gridarea {grid-area: e;}

         /* 왼쪽 요약 그리드 **/
         #container>#first-summary-gridarea {grid-area: f;}

         /* 오른쪽 요약 그리드 */
         #container>#second-summary-gridarea {grid-area: g;}

         /****** 폼 레이아웃 정렬을 위한 스타일 덮어쓰기 ******/
         /* 콤보 박스 */
         things-combo {
            display: grid;
            grid-template:
               "a b c" auto / minmax(62px, 15%) minmax(100px, 1fr) auto;
            grid-gap: 5px;

            --things-label: {
               min-height:25px;
               color:var(--things-primary-text-color);
               text-align:right;
               line-height:25px;
               padding-right:5px;
            };

            --things-input: {
               width: auto !important;
               padding:3px 5px 2px 5px;
               -webkit-border-radius:4px;
               -moz-border-radius:4px;
               border-radius:4px;
               border:1px solid rgba(0,0,0,.2);
               font-size:15px;
               font-weight:300;
            };

            --things-picker-button: {
               width: 30px;
               height: 25px;
               margin-left: 2px;
               -webkit-border-radius: 3px;
               -moz-border-radius: 3px;
               border-radius: 3px;
            };
         }

         things-combo>label { grid-area: a; }
         things-combo>input.input-size:not(#input) { grid-area: b; }
         things-combo>iron-icon { grid-area: c;}

         /* 인풋 필드 */
         things-input-field {
            display: grid;
            grid: auto / minmax(62px, 30%) minmax(100px, 1fr);
            grid-gap: 5px;

            --things-label: {
               min-height:25px;
               color:var(--things-primary-text-color);
               text-align:right;
               line-height:25px;
               padding-right:5px;
            };

            --things-input: {
               padding:3px 5px 2px 5px;
               -webkit-border-radius:4px;
               -moz-border-radius:4px;
               border-radius:4px;
               border:1px solid rgba(0,0,0,.2);
               font-size:15px;
               font-weight:300;
            };
         }

         /* 바깥 여백 제거 */
         .margin-zero { margin: 0px; }

         /* 안쪽 여백 제거 */
         .padding-zero { padding: 0px; }

         /* 폼 집합 그리드 레이아웃 */
         .select-form {
            display: grid;
            grid-template:
               "a b" auto
               "c c" auto / 1fr 1fr;
            grid-row-gap: 10px;
         }

         /* 로케이션 인풋 필드 */
         .select-form>.location-input-field { grid-area: a; }

         /* 거래처 인풋 필드 */
         .select-form>.customer-input-field { grid-area: b;}

         /* 호기 콤보 박스 */
         .select-form>.region-combo { grid-area: c; }
      </style>

      <!-- 메타 호출 ajax -->
      <things-ajax
         auto
         id="resource-meta"
         method="GET"
         resource-url="[[menuMetaUrl]]"
         last-response="{{metaData}}">
      </things-ajax>

      <!-- 스왑 호출 ajax -->
      <things-ajax id="das-loc-assign" method="POST">
      </things-ajax>

      <!-- 왼쪽 그리드 - 호기 로케이션 정보 호출 -->
      <things-ajax id="first-selected-region-ajax" method="GET"
         last-response="{{responseLeft}}">
      </things-ajax>

      <!-- 오른쪽 그리드 - 호기 로케이션 정보 호출 -->
      <things-ajax id="second-selected-region-ajax" method="GET"
         last-response="{{responseRignt}}">
      </things-ajax>

      <!-- 그리드 컨테이너 -->
      <div id="container">
         <!-- 서치 폼 -->
         <things-search-form
            id="search-form"
            class="margin-zero"
            form-fields="[[searchFormFields]]"
            select-fields="[[selectFields]]"
            sort-fields="[[sortFields]]"
            action-url="[[menuInfo.resource_url]]"
            page="{{page}}"
            limit="[[limit]]"
            last-response="{{lastResponse}}">
         </things-search-form>

         <!-- 왼쪽 폼 집합 -->
         <div id=first-select-form-gridarea class="select-form">
            <!-- 로케이션 인풋 필드 -->
            <things-input-field
               id="first-loc-input-field"
               class="location-input-field"
               name="location"
               label="[[labels.location]]"
               readonly>
            </things-input-field>

            <!-- 거래처 인풋 필드 -->
            <things-input-field
               id="first-cust-input-field"
               class="customer-input-field"
               name="customer"
               label="[[labels.customer]]"
               readonly>
            </things-input-field>

            <!-- 호기 선택 콤보 박스 -->
            <things-combo
               id="first-select-combo"
               class="region-combo padding-zero margin-zero"
               except-empty=true
               label="[[labels.regionSelect]]"
               label-path="description"
               value-path="name">
            </things-combo>
         </div>

         <!-- 오른쪽 폼 집합 -->
         <div id=second-select-form-gridarea class="select-form">
            <!-- 로케이션 인풋 필드 -->
            <things-input-field
               id="second-loc-input-field"
               class="location-input-field"
               name="location"
               label="[[labels.location]]"
               readonly>
            </things-input-field>

            <!-- 거래처 인풋 필드 -->
            <things-input-field
               id="second-cust-input-field"
               class="customer-input-field"
               name="customer"
               label="[[labels.customer]]"
               readonly>
            </things-input-field>

            <!-- 호기 선택 콤보 박스 -->
            <things-combo
               id="second-select-combo"
               class="region-combo padding-zero margin-zero"
               except-empty=true
               label="[[labels.regionSelect]]"
               label-path="description"
               value-path="name">
            </things-combo>
         </div>

         <!-- 호기 요약 정보 - 왼쪽 -->
         <things-resource-grid
            id="first-summary-gridarea"
            class="padding-zero"
            model="[[sumGridModel]]"
            columns="[[sumGridColumns]]"
            config="[[sumGridConfig]]"
            data="[[summaryForLeft]]"
            buttons=""
            fixed-column-count="0">
         </things-resource-grid>

         <!-- 호기의 로케이션 정보 - 왼쪽 -->
         <things-resource-grid
            id="first-gridarea"
            order="first"
            class="padding-zero"
            model="[[gridModel]]"
            columns="[[myGridColumns]]"
            config="[[gridConfig]]"
            data="[[responseLeft.locList]]"
            limit="10000"
            fixed-column-count="0">
         </things-resource-grid>

         <!-- 호기 요약 정보 - 오른쪽 -->
         <things-resource-grid
            id="second-summary-gridarea"
            class="padding-zero"
            model="[[sumGridModel]]"
            columns="[[sumGridColumns]]"
            config="[[sumGridConfig]]"
            data="[[summaryForRight]]"
            buttons=""
            fixed-column-count="0">
         </things-resource-grid>

         <!-- 호기의 로케이션 정보 - 오른쪽 -->
         <things-resource-grid
            id="second-gridarea"
            order="second"
            class="padding-zero"
            model="[[gridModel]]"
            columns="[[myGridColumns]]"
            config="[[gridConfig]]"
            data="[[responseRignt.locList]]"
            limit="10000"
            fixed-column-count="0"
            buttons="[[buttons]]">
         </things-resource-grid>
      </div>
   </template>

   <script>
      Polymer({
         is: 'das-location-assignment',

         behaviors: [
            Things.MsgBoxBehavior,
            Things.NamedMetaBehavior
         ],

         properties: {
            /**
             * 라벨 텍스트 모음
             ****************
             * @type {Object}
             */
            labels: {
               type: Object,
               value: function() {
                  return {
                     regionSelect: Things.DataGlobal.t("title.region_select"),
                     location: Things.DataGlobal.t('label.location'),
                     customer: Things.DataGlobal.t('label.customer')
                  };
               }
            },

            /**
             * 왼쪽 호기의 로케이션 별 거래처 매핑 정보 응답
             ****************
             * @type {Object}
             */
            responseLeft: {
               type: Object,
               observer: "_responseLeftChanged"
            },

            /**
             * 오른쪽 호기의 로케이션 별 거래처 매핑 정보 응답
             ****************
             * @type {Object}
             */
            responseRignt: {
               type: Object,
               observer: "_responseRightChanged"
            },

            /**
             * 왼쪽 호기의 물량 요약 정보 응답
             ****************
             * @type {Object}
             */
            summaryForLeft: {
               type: Array
            },

            /**
             * 오른쪽 호기의 물량 요약 정보 응답
             ****************
             * @type {Object}
             */
            summaryForRight: {
               type: Array
            },

            /**
             * 호기의 로케이션 정보 그리드 설정
             ****************
             * @type {Object}
             */
            gridConfig: {
               type: Object,
               value: function () {
                  return {
                     options: {
                        edit: {
                           pasteEnabled: false
                        },
                        display: {
                           fitStyle: 'fill'
                        },
                        checkBar: {
                           exclusive: true
                        }
                     }
                  };
               }
            },

            /**
             * 요약 정보 그리드 설정
             ****************
             * @type {Object}
             */
            sumGridConfig: {
               type: Object,
               value: function () {
                  return {
                     options: {
                        edit: {
                           pasteEnabled: false
                        },
                        rowIndicator: {
                           visible: false
                        },
                        display: {
                           fitStyle: 'fill'
                        },
                        checkBar: {
                           visible: false
                        }
                     }
                  };
               }
            },

            /**
             * 요약 정보 그리드 모델
             ****************
             * @type {Array}
             */
            sumGridModel: {
               type: Array,
               value: function () {
                  return [{
                     fieldName: 'cust_cnt', dataType: 'number'
                  }, {
                     fieldName: 'sku_qty', dataType: 'number'
                  }, {
                     fieldName: 'pcs_qty', dataType: 'number'
                  }];
               }
            },

            /**
             * 요약 정보 그리드 컬럼
             ****************
             * @type {Array}
             */
            sumGridColumns: {
               type: Array,
               value: function () {
                  return [{
                     fieldName: 'cust_cnt',
                     name: 'cust_cnt',
                     header: { text: Things.DataGlobal.t('label.cust_cnt') },
                     editable: false,
                     styles: {
                        textAlignment: 'far', numberFormat: '#,###'
                     }
                  }, {
                     fieldName: 'sku_qty',
                     name: 'sku_qty',
                     header: { text: Things.DataGlobal.t('label.sku_qty') },
                     editable: false,
                     styles: {
                        textAlignment: 'far', numberFormat: '#,###'
                     }
                  }, {
                     fieldName: 'pcs_qty',
                     name: 'pcs_qty',
                     header: { text: Things.DataGlobal.t('label.pcs_qty') },
                     editable: false,
                     styles: {
                        textAlignment: 'far', numberFormat: '#,###'
                     }
                  }];
               }
            }
         },

         listeners: {
            /* 메타 정보 받음 */
            'resource-meta.things-ajax-response':'_gotMeta',
            /* 서치 폼 구성됨 */
            'search-form.things-search-form-configured': '_initSearchForm',
            /* 왼쪽 콤보 박스 내용 선택됨 */
            'first-select-combo.things-combo-value-changed': 'searchFirstRegion',
            /* 오른쪽 콤보 박스 내용 선택됨 */
            'second-select-combo.things-combo-value-changed': 'searchSecondRegion',
            /* 그리드 구성됨 */
            'things-grid-configured': '_gridConfigured',
            /* 로케이션 스왑 버튼 누름 */
            'second-gridarea.swap-btn-tap': '_callSwapAjax',
            /* 초기화 버튼 누름 */
            'second-gridarea.reset-btn-tap': '_reset',
            /* 스왑 처리 완료됨 */
            'das-loc-assign.things-ajax-response': '_openSuccessToProcessMsg',
            /* 서치 폼의 검색 버튼 누름 */
            'search-form.things-form-pre-submit': '_reset',
            /* 검색한 정보 받음 */
            'search-form.things-form-submit-success': '_onSubmitSuccess'
         },

         /**
          * 서버로 부터 메뉴 설정 메타 정보를 받은 후 ...
          *****************
          * @param {Object} e
          */
         _gotMeta: function(e) {
            this._setColumns();
         },

         /**
          * 컬럼 설정
          *****************
          */
         _setColumns: function() {
            var columns = this.gridColumns; // 메타 내용 불러옴

            // 사이드(앞·뒤) 컬럼 옵션
            var side = columns.findIndex(function (element) {
               return element.name === "side_cd";
            });

            if (side) {
              columns[side].editable = false; // 컬럼 편집 불가
            }

            this.myGridColumns = columns; // 적용
         },

         /**
          * 서치 폼 초기화
          *****************
          * @param {Object} e
          */
         _initSearchForm: function (e) {
            e.target.setFormData({batch_id: this.batchId});
            e.target.submitMyForm();
         },

         /**
          * 왼쪽 호기 그리드 정보 변경시 ...
          *****************
          * @param {Object} value
          */
         _responseLeftChanged(value) {
            this.summaryForLeft = [value.summary];
         },

         /**
          * 오른쪽 호기 그리드 정보 변경시 ...
          *****************
          * @param {Object} value
          */
         _responseRightChanged(value) {
            this.summaryForRight = [value.summary];
         },

         /**
          * 왼쪽 콤보 박스에서 선택한 호기의 로케이션 정보 검색
          *****************
          * @param {Object} e
          */
         searchFirstRegion: function (e) {
            var region = this.$['first-select-combo'].value;
            if(region) {
              var ajaxUrl = this.menuInfo.resource_url + '/' + this.batchId + '/' + region + '/locations';
              this.$['first-selected-region-ajax'].resourceUrl = ajaxUrl;
              this.$['first-selected-region-ajax'].generateRequest();
            }
         },

         /**
          * 오른쪽 콤보 박스에서 선택한 호기의 로케이션 정보 검색
          *****************
          * @param {Object} e
          */
         searchSecondRegion: function (e) {
            var region = this.$['second-select-combo'].value;
            if(region) {
              var ajaxUrl = this.menuInfo.resource_url + '/' + this.batchId + '/' + region + '/locations';
              this.$['second-selected-region-ajax'].resourceUrl = ajaxUrl;
              this.$['second-selected-region-ajax'].generateRequest();
            }
         },

         /**
          * 그리드가 구성 완료된 후 ...
          *****************
          * @param {Object} e
          */
         _gridConfigured: function (e) {
            // autoFill 옵션 해제
            e.target.grid.autoFill().setEnabled(false);

            // 로케이션 정보 그리드인지 확인
            switch(e.target.id) {
               case 'first-gridarea':
               case 'second-gridarea': {
                  var locField = this.$[e.target.getAttribute('order') + '-loc-input-field'];
                  var custField = this.$[e.target.getAttribute('order') + '-cust-input-field'];

                  // 체크 이벤트 추가
                  e.target.grid.onRowChecked = function (grid, row, checked) {
                     var rowObject = row.getRowObject();
                     locField.value = rowObject.loc_cd;
                     custField.value = rowObject.cust_cd;
                     locField['batch-id'] = rowObject.batch_id;
                  }
               } break;
            }
         },

         /**
          * 서버에 로케이션 스왑 요청
          *****************
          * @param {Object} e
          */
         _callSwapAjax: function (e) {
            firstLoc = this.$['first-loc-input-field'].value;
            secondLoc = this.$['second-loc-input-field'].value;

            // 바꿀 로케이션이 선택되지 않았을 때
            if (!firstLoc || !secondLoc) {
               this.openConfirmMsg({
                  type: 'info',
                  title: Things.DataGlobal.t('title.info'),
                  text: Things.DataGlobal.t('text.please_choose_location'),
                  showCancelButton: false
               });
               return;
            };

            // 같은 로케이션을 선택했을 때
            if(firstLoc === secondLoc) {
               this.openConfirmMsg({
                  type: 'info',
                  title: Things.DataGlobal.t('title.info'),
                  text: Things.DataGlobal.t('text.is_same_location'),
                  showCancelButton: false
               });
               return;
            };

            this.$['das-loc-assign'].resourceUrl =
               this.menuInfo.resource_url + '/' +
               this.$['first-loc-input-field']['batch-id'] + '/' +
               firstLoc + '/' +
               this.$['second-loc-input-field']['batch-id'] + '/' +
               secondLoc + '/swap';
            this.$['das-loc-assign'].generateRequest();
         },

         /**
          * 현재 서치 폼에 입력된 배치 ID 리턴
          **************
          */
         _getCurrentBatchId: function () {
            var formData = this.$['search-form'].serializeMyForm();
            return formData.batch_id;
         },

         /**
          * 스왑 성공 시 메시지 창 띄움
          *****************
          * @param {Object} e
          */
         _openSuccessToProcessMsg: function (e) {
            // 로케이션 정보를 갱신하고 폼 내용 비움
            refresh = function () {
               this.searchFirstRegion();
               this.searchSecondRegion();
               this.$['first-loc-input-field'].value = '';
               this.$['first-cust-input-field'].value = '';
               this.$['second-loc-input-field'].value = '';
               this.$['second-cust-input-field'].value = '';
            }.bind(this);

            // 성공 메시지 띄우기
            this.openConfirmMsg({
               type: 'success',
               title: Things.DataGlobal.t('label.success'),
               text: Things.DataGlobal.t('text.Success to Process'),
               showCancelButton: false
            }, refresh);
         },

         /**
          * 서치 폼으로 호기 목록을 받으면, 목록 첫번째 호기의 로케이션 데이터를 ajax 호출
          **************
          * @param {Array} list 호기 목록
          */
         _callLocationInfo: function (list) {
            this.$['first-select-combo'].value = list[0] ? list[0][this.$['first-select-combo'].valuePath] : '';
            this.$['second-select-combo'].value = list[0] ? list[0][this.$['second-select-combo'].valuePath] : '';

            this.searchFirstRegion();
            this.searchSecondRegion();
         },

         /**
          * 폼 내용 비우고, 그리드 체크 해제
          **************
          */
         _reset: function() {
            try {
               this.$['first-loc-input-field'].value = '';
               this.$['first-cust-input-field'].value = '';
               this.$['second-loc-input-field'].value = '';
               this.$['second-cust-input-field'].value = '';
               this.$['first-gridarea'].grid.checkAll(false);
               this.$['second-gridarea'].grid.checkAll(false);
            } catch(e) {
            }
         },

         /**
          * 호기 목록을 콤보 박스에 넣음
          **************
          * @param {Array} list 호기 목록
          */
         _setComboItems: function (list) {
            this.$['first-select-combo'].items = list;
            this.$['second-select-combo'].items = list;
         },

         /**
          * 검색으로 호기 목록 받음
          **************
          * @param {Array} e
          */
         _onSubmitSuccess: function (e) {
            var list = e.detail;
            this.batchId = this._getCurrentBatchId();

            if(list.length === 0) {
               this._purgeGrid();
            }
            this._callLocationInfo(list);
            this._setComboItems(list);
         },

         /**
          * 그리드 내용 비움
          **************
          */
         _purgeGrid: function () {
            this.querySelectorAll('things-resource-grid').forEach(function(grid) {
               grid.getGridDataSet().setRows([]);
            });
         }
      });
   </script>
</dom-module>
