<!--
@license
Copyright © HatioLab Inc. All rights reserved.
-->
<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/things-ajax/things-ajax.html">
<link rel="import" href="../../bower_components/things-form/things-search-form.html">
<link rel="import" href="../../bower_components/things-grid/things-resource-grid.html">
<link rel="import" href="../../bower_components/things-content/things-resource-menu-content-behavior.html">

<!--
	주문 및 작업 > DAS 상품 내역
-->

<dom-module id="das-result-by-sku">
  <template>
    <style>
      :host {
        @apply(--layout-flex);
        @apply(--layout-vertical);
      }
      .container {
        @apply(--layout-flex);
        display: grid;
        grid-template-rows: 90px auto;
        grid-template-columns: 1.2fr 1fr;
      }
      #summary-grid {
        grid-row-start: 1;
        grid-row-end: 2;
      }
      #sku-grid {
        grid-row-start: 2;
        grid-row-end: 3;
      }
      #cust-grid {
        grid-row-start: 2;
        grid-row-end: 3;
      }
    </style>

    <!-- Get Menu Meta Ajax -->
		<things-ajax
			auto
			id="resource-meta"
			resource-url="[[menuMetaUrl]]"
			resource-action="index"
			last-response="{{metaData}}">
    </things-ajax>

    <!-- Data Ajax -->
		<things-ajax
			id="summary-ajax"
			resource-url="diy_services/das-result-by-sku-summary/read"
			resource-action="get"
			last-response="{{summaryData}}">
    </things-ajax>

    <things-ajax
			id="detail-ajax"
			resource-url="diy_services/das-result-by-sku-detail/read"
			resource-action="get"
			last-response="{{detailData}}">
    </things-ajax>

    <!-- Search form -->
		<things-search-form
			id="search-form"
			title="[[menuInfo.title]]"
			form-fields="[[searchFormFields]]"
			select-fields="[]"
			sort-fields="[]"
			action-url="[[menuInfo.resource_url]]"
			page="{{page}}"
      limit="{{limit}}"
			last-response="{{lastResponse}}">
    </things-search-form>

    <div class="container">
      <things-resource-grid
        id="summary-grid"
        config="[[commonGridConfig]]"
        model="[[dasResultBySkuSumGridModel]]"
        columns="[[dasResultBySkuSumGridColumns]]"
        fixed-column-count="0"
        data="[[summaryData]]"
        buttons="[[emptyButtons]]">
      </things-resource-grid>

      <things-resource-grid
				id="sku-grid"
				config="[[commonGridConfig]]"
				model="[[gridModel]]"
				columns="[[gridColumns]]"
				data="[[items]]"
				total-count="[[itemCount]]"
				current-page="{{page}}"
				limit="{{limit}}"
				paginatable
				show-paginator
				fixed-column-count="[[menuInfo.fixed_columns]]"
				buttons="[[emptyButtons]]">
			</things-resource-grid>

      <things-resource-grid
        id="cust-grid"
        config="[[commonGridConfig]]"
        model="[[dasResultBySkuCustGridModel]]"
        columns="[[dasResultBySkuCustGridColumns]]"
        fixed-column-count="0"
        data="[[detailData]]"
        buttons="[[emptyButtons]]">
      </things-resource-grid>
    </div>
  </template>

  <script>
    Polymer({
      is: 'das-result-by-sku',

      behaviors: [
				Things.ResourceMenuContentBehavior
      ],

      properties: {
        /**
				 * 메뉴 ID
				 */
				menuId: {
					type: String
				},

				/**
				 * 상세 화면 구성을 위해 필요한 메뉴 메타 데이터를 조회하기 위한 URL
				 */
				menuDetailMetaUrl: {
					type: String,
					computed: '_computeMenuDetailMetaUrl(menuId)',
					observer: '_invokeDetailMetaData'
				},

				/**
				 * 마스터 데이터를 마스터 그리드에 표시할 select 필드
				 */
				masterSelectFields: {
					type: String
				},

				/**
				 * 메뉴 Detail 화면 구성을 위한 메타 데이터
				 */
				detailMetaData: {
					type: Array,
					observer: '_parseDetailMetaData'
				},

        /**
				 * 메인 그리드 데이터
				 */
        summaryData : {
          type: Array
        },

        /**
				 * 서브 그리드 데이터
				 */
        detailData: {
          type: Array
        },

        /**
				 * 빈 버튼 리스트
				 */
        emptyButtons: {
          type: Array,
          value: function() {
            return [];
          }
        },

        /**
				 * 그리드 공통 구성 정보
				 */
        commonGridConfig: {
          type: Object,
          value: function() {
            return {
              checkBar: {
                visible: false
              }
            }
          }
        }
      },

      listeners: {
        'sku-grid.things-grid-row-data-select': 'refreshSubGrid'
      },

      observers: [
				'_gridColumnsChanged(gridColumns)'
			],

			/**
 			 * 마스터 그리드 컬럼이 변경된 이후
 			 * @param {Object} gridColumns 그리드 컬럼
 			 ****************
			 */
			_gridColumnsChanged: function(gridColumns) {
				var selectColumns = '';
				gridColumns.forEach(function(metaData) {
					if(!metaData.virtual_field || metaData.virtual_field == false) {
						selectColumns += metaData.name + ',';
					}
				});
				if(selectColumns.length > 2) {
					this.masterSelectFields = selectColumns.substr(0, selectColumns.length - 1);
				}
			},

      /**
 			 * 메뉴 디테일 메타 정보 조회
 			 * @param {String} menuDetailMetaUrl
 			 ****************
			 */
       _invokeDetailMetaData: function(menuDetailMetaUrl) {
				var detailMetaAjax = document.createElement('things-ajax');
				detailMetaAjax.resourceId = this.menuId;
				detailMetaAjax.resourceUrl = menuDetailMetaUrl;
				detailMetaAjax.addEventListener('things-ajax-response', function(event) {
					this.detailMetaData = event.detail;
				}.bind(this));
				detailMetaAjax.generateRequest();
			},

			/**
			 * menuId로 부터 메뉴 상세 메타 데이터 조회를 위한 URL을 생성
			 * @param {String} menuId 메뉴 아이디
			 * @return {String} 메뉴 상세 메타 데이터 조회를 위한 URL
       ****************
			 */
			_computeMenuDetailMetaUrl: function(menuId) {
				return 'menu_details/' + menuId + '/meta';
			},

			/**
			 * 서버로 부터 응답받은 메뉴 상세에 대한 메타 데이터를 상세 화면 구성을 위해 필요한 메타 데이터로 변환한다.
			 * @param {Array} detailMetaList 서버로 부터 응답받은 메뉴 상세에 대한 메타 데이터
       ****************
			 */
			 _parseDetailMetaData: function(detailMetaList) {
				if(!detailMetaList || detailMetaList.length == 0) {
					return;
				}

				for(var i = 0 ; i < detailMetaList.length ; i++) {
					var metaData = detailMetaList[i];

					if(metaData.association != 'one-to-many') {
						continue;
					}

          this[metaData.name + 'Title'] = metaData.name;
          this[metaData.name + 'SearchUrl'] = metaData.search_url;
          this[metaData.name + 'SaveUrl'] = metaData.save_url;
          this[metaData.name + 'Field'] = metaData.master_field;

					if(metaData.menu_detail_buttons) {
						var buttons = this._parseButtons(metaData.menu_detail_buttons);
						if(buttons && buttons.length > 0) {
							buttons.forEach(function(button) { button.id = button.name + '-btn'; });
						}
            this[metaData.name + 'Buttons'] = buttons;
					}

					if(metaData.menu_detail_columns) {
						// Parse Grid Models - Grid
            this[metaData.name + 'GridModel'] = this._parseGridModel(metaData.menu_detail_columns);
						// Parse Grid Columns - Grid
            this[metaData.name + 'GridColumns'] = this._parseGridColumns(metaData.menu_detail_columns)
					}
				}

				this.fire('detail-meta-data-configured');
			},

			/**
			 * 마스터 데이터 조회
			 * @param {Object} event
       **************
			 */
			refreshMaster: function(event) {
				this.$['search-form'].submitMyForm();
			},

      /**
    	 * Override
    	 ************
    	 */
    	refreshData: function() {
    		if(!this.initialSearchFlag) {
    			this.initialSearchFlag = true;
    		}
    	},

      /**
    	 * 조회 데이터 변경시
    	 * @param {Object} lastResponse
    	 ************
    	 */
    	_responseChanged: function(lastResponse) {
    		this.items = (this.itemsProp && lastResponse[this.itemsProp]) ? lastResponse[this.itemsProp] : lastResponse;
    		this.itemCount = (this.totalProp && lastResponse[this.totalProp]) ? lastResponse[this.totalProp] : lastResponse.length;

        if(this.itemCount && this.itemCount > 0) {
          var ajax = this.$['summary-ajax'];
          var params = this.$['search-form'].serializeMyForm();
          ajax.params = {
            job_date : params.job_date,
            job_batch_seq : params.job_batch_seq
          };
          ajax.generateRequest();
        }
    	},

      /**
       * 서브 그리드를 리프레쉬
       * @param {Object} event
       ************
       */
      refreshSubGrid: function(event) {
        var resource = event.detail;
        var ajax = this.$['detail-ajax'];
        ajax.params = resource;
        ajax.generateRequest();
      }
    });
  </script>
</dom-module>
