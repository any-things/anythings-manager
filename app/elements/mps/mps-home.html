<!--
@license
Copyright © HatioLab Inc. All rights reserved.
-->
<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/things-ajax/things-ajax.html">
<link rel="import" href="../../bower_components/things-grid/things-resource-grid.html">

<link rel="import" href="../../bower_components/things-meta/things-named-meta-behavior.html">
<!--
  MPS Home View
 -->

 <dom-module id="mps-home">
  <template>
    <style>
      :host {
        @apply --layout-flex;
        @apply --layout-vertical;
      }
      .container {
        height: 100%;
        display: grid;
        grid-template-rows: 45% 55%;
        grid-template-columns: 55% 45%;
        border-radius:4px;
      }
      .bottom-section {
        @apply --layout-vertical;
        @apply --layout-flex;
        grid-column-start: 1;
        grid-column-end: 3;
      }
      #gauge-chart-container {
        display: grid;
      }
      #barchart-container {
        display: grid;
        grid-template-rows: 33% 33% 33%;
      }
      #barchart-container div{
        width:calc(100% - 15px);
      }
      things-resource-grid {
        @apply --layout-vertical;
        @apply --layout-flex;
      }
      ::shadow .c3-chart-arc path{
        stroke:rgba(0,0,0,.1);
      }
      ::shadow .c3-chart-arcs .c3-chart-arcs-background{
        fill: rgba(0,0,0,.1);
        stroke: rgba(0,0,0,.1);
      }
      ::shadow .c3-chart-arcs text,::shadow .c3-legend-item text{
        fill: #fff;
      }
      ::shadow .c3-axis {
        fill: rgba(255, 255, 255, .4);
      }
      ::shadow .c3-axis .domain,::shadow .c3-axis line{
        stroke: rgba(255, 255, 255, .4);
      }
      #barchart-container ::shadow .c3-legend-item{
        margin-top:-20px
      }
    </style>

    <things-ajax
      auto
      id="named-menu-meta-ajax"
      resource-url="[[menuMetaUrl]]"
      resource-action="find"
      last-response="{{metaData}}">
    </things-ajax>

    <things-ajax
      id="chart-data-ajax"
      resource-action="find"
      resource-url="job_batch/progress_rate">
    </things-ajax>

    <things-ajax
      id="data-ajax"
      resource-action="index"
      resource-url="[[menuInfo.resource_url]]"
      last-response="{{lastResponse}}">
    </things-ajax>

    <div class="container">
      <div id="gauge-chart-container">
        <div id="gauge-chart"></div>
      </div>

      <div id="barchart-container">
        <div id="order-chart"></div>
        <div id="sku-chart"></div>
        <div id="pcs-chart"></div>
      </div>

      <div class="bottom-section">
        <things-resource-grid
          id="grid"
          config="[[gridConfig]]"
          model="[[gridModel]]"
          columns="[[gridColumns]]"
          buttons="[[buttons]]"
          current-page="{{page}}"
    			limit="{{limit}}"
    			data="[[items]]"
    			total-count="[[itemCount]]"
          fixed-column-count="[[menuInfo.fixed_columns]]">
        </things-resource-grid>
      </div>
    </div>
  </template>

  <script>
     Polymer({
      is: 'mps-home',

      behaviors: [
        Things.NamedMetaBehavior
      ],

      properties: {
        /**
         * ajax 데이터 조회 결과
         */
        lastResponse: {
          type: Object,
          observer: '_responseChanged'
        },

        /**
         * items 결과
         */
        items: {
          type: Array
        }
      },

      listeners: {
        'search-btn-tap': 'searchData',
        'grid.things-grid-configured': '_gridConfigured',
        'chart-data-ajax.things-ajax-response': '_chartDataChanged'
      },

      /**
       * ready
       */
      ready: function() {
        // TODO 메튜 타이틀에 메뉴명 표시 필요
        this.resourceName = 'Home';
        this.limit = 10000;

        document.addEventListener('things-routing-changed-home', function(event) {
          this._routingChanged(event);
        }.bind(this));
      },

      /**
    	 * 라우팅 변경시 ...
    	 * @param {Object} event 라우팅
    	 * *****
    	 */
    	_routingChanged: function(event) {
        this.searchData();
    	},

      /**
       * 그리드 구성 후 ...
       *******************
       * @param {Object} grid
       */
      _gridConfigured: function(grid) {
        this.searchData();
      },

      /**
    	 * 조회 데이터 변경시
    	 * @param {Object} lastResponse
    	 ******
    	 */
    	_responseChanged: function(lastResponse) {
        var items = lastResponse['items'] ? lastResponse['items'] : lastResponse;
        this.items = this._itemsChanged(items);
        this.itemCount = lastResponse['total'] ? lastResponse['total'] : lastResponse.length;
    	},

      /**
    	 * 데이터 변경시 ...
    	 * @param {Array} items
    	 ******
    	 */
      _itemsChanged: function(items) {
        return items.map(function(item) {
          if(!item.wms_order_cnt || !item.mps_order_cnt || item.wms_order_cnt == 0 || item.mps_order_cnt == 0) {
            item.progress_rate = 0;
          } else {
            item.progress_rate = (item.mps_order_cnt / item.wms_order_cnt) * 100;
          }

          return item;
        });
      },

      /**
       * 데이터 검색 ...
       *******************
       * @param {Object} event
       */
      searchData: function(event) {
        var today = moment(new Date()).format('YYYY-MM-DD');

        var chartAjax = this.$['chart-data-ajax'];
        if(chartAjax) {
          chartAjax.params = { job_date : today };
          chartAjax.generateRequest();
        }

        var dataAjax = this.$['data-ajax'];
        if(dataAjax) {
          dataAjax.queryFields = [{ name : 'job_date', value : today }];
          dataAjax.generateRequest();
        }
      },

      /**
       * 차트 데이터가 변경 되었을 때 ...
       *******************
       * @param {Object} event
       */
      _chartDataChanged: function(event) {
        var data = event.detail;
        this._renderGaugeChart(data.total.rate, data.total.max, data.total.value);
        this._renderOrderBar(data.order);
        this._renderSkuBar(data.sku);
        this._renderPcsBar(data.pcs);
      },

      /**
       * 게이지 차트 렌더링
       *******************
       * @param {Number} rate
       * @param {Number} max
       * @param {Number} value
       */
      _renderGaugeChart: function(rate, plan, actual) {
        var legend = Things.DataGlobal.t('label.progress_rate');

        if(this.gaugeChart) {
          this.gaugeChart.load({columns: [[legend , rate]]});

        } else {
          this.gaugeChart = c3.generate({
            bindto: this.$['gauge-chart'],
            data: {
              columns: [[legend, rate]],
              type: 'gauge'
            },
            color: {
              pattern: ['#FF0000', '#F97600', '#F6C600', '#60B044'],
              threshold: {
                values: [30, 60, 90, 100]
              }
            }
          })
        }
      },

      /**
       * 주문 바 차트 렌더링
       *******************
       * @param {Object} data
       */
      _renderOrderBar: function(data) {
        var plan = Things.DataGlobal.t('label.order') + ' ' + Things.DataGlobal.t('label.plan');
        var actual = Things.DataGlobal.t('label.order') + ' ' + Things.DataGlobal.t('label.actual');

        if(this.orderChart) {
          this.orderChart.load({
            columns: [
              [ actual, data.actual ],
              [ plan, data.plan ]
            ]
          });

        } else {
          this.orderChart = c3.generate({
            bindto: this.$['order-chart'],
            data: {
              columns: [
                [ actual, data.actual ],
                [ plan, data.plan ]
              ],
              type: 'bar',
              colors: {
                  data1: '#ff0000',
                  data2: '#00ff00'
              },
              labels: true
            },
            padding: {
              top: 20,
              bottom: 20
            },
            bar: {
              width: {
                ratio: 1
              }
            },
            axis: {
              rotated: true,
              x: {
                show: false
              },
              y: {
                max: data.plan
              }
            }
          })
        }
      },

      /**
       * SKU 바 차트 렌더링
       *******************
       * @param {Object} data
       */
      _renderSkuBar: function(data) {
        var plan = Things.DataGlobal.t('label.sku') + ' ' + Things.DataGlobal.t('label.plan');
        var actual = Things.DataGlobal.t('label.sku') + ' ' + Things.DataGlobal.t('label.actual');

        if(this.skuChart) {
          this.skuChart.load({
            columns: [
              [ actual, data.actual ],
              [ plan, data.plan ]
            ]
          });
        } else {
          this.skuChart = c3.generate({
            bindto: this.$['sku-chart'],
            data: {
              columns: [
                [ actual, data.actual ],
                [ plan, data.plan ]
              ],
              type: 'bar',
              colors: {
                  data1: '#ff0000',
                  data2: '#00ff00'
              },
              labels: true
            },
            padding: {
              top: 20,
              bottom: 20
            },
            bar: {
              width: {
                ratio: 1
              }
            },
            axis: {
              rotated: true,
              x: {
                show: false
              },
              y: {
                max: data.plan
              }
            }
          })
        }
      },

      /**
       * PCS 바 차트 렌더링
       *******************
       * @param {Object} data
       */
      _renderPcsBar: function(data) {
        var plan = Things.DataGlobal.t('label.pcs') + ' ' + Things.DataGlobal.t('label.plan');
        var actual = Things.DataGlobal.t('label.pcs') + ' ' + Things.DataGlobal.t('label.actual');

        if(this.pcsChart) {
          this.pcsChart.load({
            columns: [
              [ actual, data.actual ],
              [ plan, data.plan ]
            ]
          });
        } else {
          this.pcsChart = c3.generate({
            bindto: this.$['pcs-chart'],
            data: {
              columns: [
                [ actual, data.actual ],
                [ plan, data.plan ]
              ],
              type: 'bar',
              colors: {
                  data1: '#ff0000',
                  data2: '#00ff00'
              },
              labels: true
            },
            padding: {
              top: 20,
              bottom: 20
            },
            bar: {
              width: {
                ratio: 1
              }
            },
            axis: {
              rotated: true,
              x: {
                show: false
              },
              y: {
                max: data.plan
              }
            }
          })
        }
      }
    })
  </script>
 </dom-module>
