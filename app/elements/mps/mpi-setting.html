<!--
@license
Copyright © HatioLab Inc. All rights reserved.
-->
<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/things-ajax/things-ajax.html">
<link rel="import" href="../../bower_components/things-form/things-search-form.html">
<link rel="import" href="../../bower_components/things-grid/things-resource-grid.html">
<link rel="import" href="../../bower_components/things-content/things-resource-menu-content-behavior.html">

<dom-module id="mpi-setting">
   <template>
      <style>
         :host {
            display: flex;
            height: calc(100% - 5px);
            padding: 5px 15px 0 15px;

            --small-gap: 5px;
            --normal-gap: 10px;
            --default-gap: 15px;
            --large-gap: 20px;
         }

         paper-toolbar::shadow #bottomBar {
            @apply --layout-horizontal;
            @apply --layout-end-justified;
         }

         #container {
            @apply --layout-flex;

            display: grid;
            grid-template-rows: auto 1fr auto;
            grid-gap: var(--default-gap);
         }

         #option-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-auto-rows: minmax(300px, 100%);
            grid-gap: var(--large-gap);

            overflow-y: scroll;
         }

         #option-container>div {
            display: grid;
            grid-template-rows: auto 1fr;
            grid-gap: var(--small-gap);
         }

         .option-block {
            @apply --layout-vertical;

            padding: 0 var(--default-gap);

            background: white;
            border-radius: 5px;
            overflow-x: auto;
            overflow-y: scroll;
         }

         .option {
            display: grid;
            grid-template: auto / 1fr;
            padding: var(--large-gap) 0;

            border-bottom: 1px dashed #EEE;
         }

         .input-wrapper {
            display: flex;
            flex-wrap: wrap;
            margin: 0 calc(-1 * var(--normal-gap));
         }

         .input-wrapper>* {
            flex: 1 1 100px;
            margin: 0 var(--normal-gap) var(--normal-gap) var(--normal-gap);
         }

         .title {
            color: white;
            font-size: 15pt;
         }

         .subtitle {
            font-size: 12pt;
            color: black;
            padding: 0;
         }

         .subtitle:before {
            content: '';
            @apply --things-subtitle-icon;
         }

         .description {
            color: #AAA;
            font-size: 10pt;
         }

         /* 바깥 여백 제거 */

         .margin-zero {
            margin: 0px;
         }

         /* 안쪽 여백 제거 */

         .padding-zero {
            padding: 0px;
         }

         p {
            word-break: break-all;
            margin: 0 0 var(--normal-gap) 0;
         }

         .things-combo-field {
            display: grid;
            grid-template: "a b" auto / minmax(40px, 1fr) auto;
            grid-gap: 5px;

            --things-label: {
               display: none;
            }

            --things-input: {
               width: auto !important;
               padding: 3px 5px 2px 5px;
               -webkit-border-radius: 4px;
               -moz-border-radius: 4px;
               border-radius: 4px;
               border: 1px solid rgba(117, 60, 60, 0.2);
               font-size: 15px;
               font-weight: 300;
            }

            --things-picker-button: {
               width: 30px;
               height: 25px;
               margin-left: 2px;
               -webkit-border-radius: 3px;
               -moz-border-radius: 3px;
               border-radius: 3px;
            }
         }

         .things-combo-field>input.input-size:not(#input) {
            grid-area: a;
         }

         .things-combo-field>iron-icon {
            grid-area: b;
         }

         /* 인풋 필드 */

         .things-field {
            display: grid;
            grid-auto-rows: auto;

            --things-label: {
               display: none !important;
            }

            --things-input: {
               width: auto !important;
               padding: 3px 5px 2px 5px;
               -webkit-border-radius: 4px;
               -moz-border-radius: 4px;
               border-radius: 4px;
               border: 1px solid rgba(0, 0, 0, .2);
               font-size: 15px;
               font-weight: 300;
            }
         }
      </style>

      <things-ajax auto id="resource-meta" resource-url="[[menuMetaUrl]]" resource-action="index" last-response="{{metaData}}">
      </things-ajax>

      <things-ajax id="update-ajax" method="PUT" content-type="application/json" resource-url="[[menuInfo.grid_save_url]]" last-response="{{lastResponse}}">
      </things-ajax>

      <div id="container">
         <things-search-form id="search-form" class="margin-zero" form-fields="[[searchFormFields]]" select-fields="[[selectFields]]"
            sort-fields="[[sortFields]]" action-url="[[menuInfo.resource_url]]" last-response="{{lastResponse}}">
         </things-search-form>
         <div id="option-container"></div>
         <paper-toolbar>
            <div class="bottom">
               <things-button-bar id="button-group" buttons="[[buttons]]"></things-button-bar>
            </div>
         </paper-toolbar>
      </div>
   </template>

   <script>
      Polymer({
         is: 'mpi-setting',

         behaviors: [
            Things.ResourceMenuContentBehavior
         ],

         properties: {
            lastResponse: {
               type: Array,
               observer: '_lastResponseChanged'
            },

            currentCompany: {
               type: String,
               value: function () {
                  return '';
               }
            },

            currentValues: {
               type: Object,
               value: function () {
                  return {};
               }
            },

            optionNameMap: {
               type: Object,
               value: function () {
                  return {
                     'mps.mpi.job.color.rtn': {
                        makeFormData: function (value) {
                           return [value];
                        },
                        formFields: [{
                           type: 'code-combo',
                           properties: {
                              codeName: 'MPI_COLOR',
                              exceptEmpty: true
                           }
                        }]
                     },
                     'mps.mpi.job.color.das': {
                        makeFormData: function (value) {
                           return [value];
                        },
                        formFields: [{
                           type: 'code-combo',
                           properties: {
                              codeName: 'MPI_COLOR',
                              exceptEmpty: true
                           }
                        }]
                     },
                     'mps.mpi.job.color.dps': {
                        makeFormData: function (value) {
                           return [value];
                        },
                        formFields: [{
                           type: 'code-combo',
                           properties: {
                              codeName: 'MPI_COLOR',
                              exceptEmpty: true
                           }
                        }]
                     },
                     'mps.mpi.job.segment.roles.on': {
                        makeFormData: function (value) {
                           var values = value.split(',');
                           return values;
                        },
                        getValue: function () {
                           var forms = this.childNodes;
                           var result = [];
                           for (let i = 0, len = forms.length; i < len; i++) {
                              result.push(forms[i].value);
                           }
                           return result.join(',');
                        },
                        formFields: [{
                           type: 'code-combo',
                           properties: {
                              codeName: 'SEGMENT_ROLE'
                           }
                        }, {
                           type: 'code-combo',
                           properties: {
                              codeName: 'SEGMENT_ROLE'
                           }
                        }]
                     },
                     "mps.mpi.show.button.blink.interval": {
                        makeFormData: function (value) {
                           return [value];
                        },
                        formFields: [{
                           type: 'number',
                           properties: {
                              min: 0
                           }
                        }]
                     },
                     "mps.mpi.action.show.chars.before.on": {
                        makeFormData: function (value) {
                           return [value];
                        },
                        formFields: [{
                           type: 'text',
                           properties: {
                              type: 'string',
                              maxlength: 6
                           }
                        }]
                     },
                     "mps.mpi.ledbar.use.enabled": {
                        makeFormData: function (value) {
                           return [value];
                        },
                        formFields: [{
                           type: 'combo',
                           properties: {
                              exceptEmpty: true,
                              items: [{
                                 name: 'true',
                                 description: 'Yes'
                              }, {
                                 name: 'false',
                                 description: 'No'
                              }]
                           }
                        }]
                     },
                     "mps.mpi.job.color.stocktaking": {
                        makeFormData: function (value) {
                           return [value];
                        },
                        formFields: [{
                           type: 'code-combo',
                           properties: {
                              codeName: 'MPI_COLOR',
                              exceptEmpty: true
                           }
                        }]
                     },
                     "mps.mpi.show.number.alignment": {
                        makeFormData: function (value) {
                           return [value];
                        },
                        formFields: [{
                           type: 'code-combo',
                           properties: {
                              codeName: 'MPI_NUM_ALIGNMENT',
                              exceptEmpty: true
                           }
                        }]
                     },
                     "mps.mpi.show.button.on.mode": {
                        makeFormData: function (value) {
                           return [value];
                        },
                        formFields: [{
                           type: 'code-combo',
                           properties: {
                              codeName: 'MPI_BUTTON_MODE',
                              exceptEmpty: true
                           }
                        }]
                     },
                     "mps.mpi.action.delay.before.on": {
                        makeFormData: function (value) {
                           return [value];
                        },
                        formFields: [{
                           type: 'number',
                           properties: {
                              max: 7,
                              min: 0
                           }
                        }]
                     },
                     "mps.mpi.action.delay.cancel.button.off": {
                        makeFormData: function (value) {
                           return [value];
                        },
                        formFields: [{
                           type: 'number',
                           properties: {
                           }
                        }]
                     },
                     "mps.mpi.show.fullbox.button.blink": {
                        makeFormData: function (value) {
                           return [value];
                        },
                        formFields: [{
                           type: 'combo',
                           properties: {
                              exceptEmpty: true,
                              items: [{
                                 name: 'true',
                                 description: 'Yes'
                              }, {
                                 name: 'false',
                                 description: 'No'
                              }]
                           }
                        }]
                     },
                     "mps.mpi.ledbar.blink.interval": {
                        makeFormData: function (value) {
                           return [value];
                        },
                        formFields: [{
                           type: 'number',
                           properties: {
                              min: 0
                           }
                        }]
                     },
                     "mps.mpi.ledbar.brightness": {
                        makeFormData: function (value) {
                           return [value];
                        },
                        formFields: [{
                           type: 'number',
                           properties: {
                              max: 10,
                              min: 1
                           }
                        }]
                     },
                     "mps.mpi.ledbar.on.mode": {
                        makeFormData: function (value) {
                           return [value];
                        },
                        formFields: [{
                           type: 'code-combo',
                           properties: {
                              codeName: 'MPI_BUTTON_MODE',
                              exceptEmpty: true
                           }
                        }]
                     },
                     "mps.mpi.action.send.off.ack.already.off": {
                        makeFormData: function (value) {
                           return [value];
                        },
                        formFields: [{
                           type: 'combo',
                           properties: {
                              exceptEmpty: true,
                              items: [{
                                 name: 'true',
                                 description: 'Yes'
                              }, {
                                 name: 'false',
                                 description: 'No'
                              }]
                           }
                        }]
                     },
                     "mps.mpi.action.show.chars.delay.before.on": {
                        makeFormData: function (value) {
                           return [value];
                        },
                        formFields: [{
                           type: 'number',
                           properties: {
                              min: 0
                           }
                        }]
                     },
                     "mps.mpi.action.status.report.interval": {
                        makeFormData: function (value) {
                           return [value];
                        },
                        formFields: [{
                           type: 'number',
                           properties: {
                              min: 0
                           }
                        }]
                     },
                     "com.mpi.display.qty.unit": {
                        hidden: true,
                        makeFormData: function (value) {
                           return [value];
                        },
                        formFields: [{
                           type: 'combo',
                           properties: {
                              exceptEmpty: true,
                              items: [{
                                 name: 'B',
                                 description: 'Box'
                              }, {
                                 name: 'P',
                                 description: 'PCS'
                              }]
                           }
                        }]
                     },
                     "com.mpi.display.segment1.mapping.role": {
                        makeFormData: function (value) {
                           return [value];
                        },
                        formFields: [{
                           type: 'code-combo',
                           properties: {
                              codeName: 'MPI_DISPLAY_SEGMENT_ROLE'
                           }
                        }]
                     },
                     "com.mpi.display.segment2.mapping.role": {
                        makeFormData: function (value) {
                           return [value];
                        },
                        formFields: [{
                           type: 'code-combo',
                           properties: {
                              codeName: 'MPI_DISPLAY_SEGMENT_ROLE'
                           }
                        }]
                     },
                     "com.mpi.display.segment3.mapping.role": {
                        hidden: true,
                        visible: false,
                        makeFormData: function (value) {
                           return [value];
                        },
                        formFields: [{
                           type: 'text',
                           properties: {
                           }
                        }]
                     },
                     "com.mpi.job.segment.roles.on": {
                        makeFormData: function (value) {
                           var values = value.split(',');
                           return values;
                        },
                        getValue: function () {
                           var forms = this.childNodes;
                           var result = [];
                           for (let i = 0, len = forms.length; i < len; i++) {
                              result.push(forms[i].value);
                           }
                           return result.join(',');
                        },
                        formFields: [{
                           type: 'code-combo',
                           properties: {
                              codeName: 'SEGMENT_ROLE'
                           }
                        }, {
                           type: 'code-combo',
                           properties: {
                              codeName: 'SEGMENT_ROLE'
                           }
                        }]
                     },
                     "mps.mpi.job.color.rotation.seq": {
                        makeFormData: function (value) {
                           var values = value.split(',');
                           return values;
                        },
                        getValue: function () {
                           var forms = this.childNodes;
                           var result = [];
                           for (let i = 0, len = forms.length; i < len; i++) {
                              let val = forms[i].value;
                              if (val) result.push(val);
                           }
                           return result.join(',');
                        },
                        formFields: [{
                           type: 'code-combo',
                           properties: {
                              codeName: 'MPI_COLOR',
                           }
                        }, {
                           type: 'code-combo',
                           properties: {
                              codeName: 'MPI_COLOR',
                           }
                        }, {
                           type: 'code-combo',
                           properties: {
                              codeName: 'MPI_COLOR',
                           }
                        }, {
                           type: 'code-combo',
                           properties: {
                              codeName: 'MPI_COLOR',
                           }
                        }]
                     }
                  };
               }
            }
         },

         listeners: {
            "search-form.things-form-submit-configured": "_beforeSearch",
            "search-form.things-form-submit-success": "_searchSuccess",
            "search-form.things-form-submit-error": "_searchFailed",
            "update-ajax.things-ajax-response": "_updateSuccess",
            "button-group.save-btn-tap": "updateSetting",
         },

         // 검색 직전 이벤트
         _beforeSearch: function (e) {
            // 기존 옵션 블록들을 제거. 고객사 미선택 상태로 변경
            this.purgeOptionContainer();
            this.currentCompany = '';

            // 기존 쿼리를 서버 스펙에 맞게 수정 / input: {key: value} => com_cd: [com_cd]
            var paramInputStr = e.detail.request.params.input;
            var newParams = {};
            var paramInputObj = JSON.parse(paramInputStr);
            if (paramInputObj.com_cd) {
               this.currentCompany = newParams.com_cd = paramInputObj.com_cd;
            }
            e.detail.request.params = newParams;
         },

         // 검색 성공 시
         _searchSuccess: function (e) {
            this.purgeOptionContainer();
            this.createOptionDiv();
         },

         // 검색 실패 시
         _searchFailed: function (e) {
            this.purgeOptionContainer();
            // 선택 고객사 없음
            this.currentCompany = '';
         },

         // 업데이트 성공 시
         _updateSuccess: function () {
            this.refreshData();
         },

         purgeOptionContainer: function () {
            // 모든 옵션 블록 제거
            var cont = this.$['option-container'];
            while (cont.firstChild) cont.removeChild(cont.firstChild); 
         },

         // 최초 옵션 분류. 타이틀이 포함된 옵션 블록을 생성
         createOptionDiv: function () {
            var cont = this.$['option-container'];

            // 구성된 폼으로 엘리먼트 생성
            var form = this.formSmithing();
            for (let i = 0, len = form.length; i < len; i++) {
               // 타이틀과 옵션 블록을 포함하는 div 생성
               let optionDiv = this.create('div');
               optionDiv.setAttribute('class', 'style-scope mpi-setting');

               // 타이틀 생성
               let title = this.createSpan('title', form[i].title);
               optionDiv.appendChild(title);

               // 옵션들이 들어갈 블록 생성
               let optionBlock = this.createOptionBlock(form[i].options);
               optionDiv.appendChild(optionBlock);

               // 컨테이너에 적용
               cont.appendChild(optionDiv);
            }
         },

         // 옵션 블록의 내용. 옵션 블록 내에 옵션 목록을 생성
         createOptionBlock: function (options) {
            var optionBlock = this.create('div');
            optionBlock.setAttribute('class', 'option-block style-scope mpi-setting');

            // 주어진 개수만큼 옵션 목록 생성
            for (let i = 0, len = options.length; i < len; i++) {
               let option = this.createOption(options[i])
               optionBlock.appendChild(option);
            }

            return optionBlock;
         },

         // 각 옵션 생성. 타이틀, 설명, 입력 박스를 포함함
         createOption: function (option) {
            var row = this.create('div');
            row.setAttribute('class', 'option style-scope mpi-setting');

            // create and set title
            let title = this.createSpan('subtitle', option.title);
            row.appendChild(title);

            // create and set description
            let p = this.create('p', { innerText: option.description });
            p.setAttribute('class', 'description style-scope mpi-setting');
            row.appendChild(p);

            // create and set input form
            let props = {
               optionId: option.optionId,
               name: option.name,
               getValue: option.getValue
            };
            let form = this.createInputForm(option.formFields, props);
            row.appendChild(form);

            return row;
         },

         // 입력용 박스 생성
         createInputForm: function (formFields, properties) {
            let wrapper = this.create('div', properties);
            wrapper.setAttribute('class', 'input-wrapper style-scope mpi-setting');

            for (let i = 0, len = formFields.length; i < len; i++) {
               let form;
               switch (formFields[i].type) {
                  case 'number': {
                     form = this.create('things-number-field', formFields[i].properties);
                     form.setAttribute('class', 'option-input things-field style-scope mpi-setting');
                  } break;
                  case 'combo': {
                     form = this.create('things-combo', formFields[i].properties);
                     form.setAttribute('class', 'option-input things-combo-field style-scope mpi-setting');
                  } break;
                  case 'code-combo': {
                     form = this.create('things-combo', formFields[i].properties);
                     form.setAttribute('class', 'option-input things-combo-field style-scope mpi-setting');

                     // create ajax
                     let props = {
                        auto: true,
                        resourceUrl: 'common_codes/show_by_name',
                        method: 'GET',
                        params: {
                           name: formFields[i].properties.codeName
                        },
                        comboElement: form
                     };
                     let codeAjax = this.create('things-ajax', props);
                     // add event listener
                     this.listen(codeAjax, 'things-ajax-response', 'setComboItems');
                  } break;
                  case 'text':
                  default: {
                     form = this.create('things-input-field', formFields[i].properties);
                     form.setAttribute('class', 'option-input things-field style-scope mpi-setting');
                  } break;
               }
               wrapper.appendChild(form);
            }

            return wrapper;
         },

         // code-combo 타입 전용) 콤보 박스 아이템 설정
         setComboItems: function (e) {
            e.target.comboElement.items = e.detail.items;
         },

         // 라벨(타이틀)을 생성하는 함수
         createSpan: function (cssClassName, innerText) {
            var span = this.create('span');
            span.setAttribute('class', cssClassName + ' style-scope mpi-setting');
            span.innerText = innerText;

            return span;
         },

         /* 규격에 맞는 폼을 만들고 반환함. 예시)
         [{
            title: '옵션 블럭 타이틀',
            options: [{
               title: '옵션 개체 타이틀',
               description: '이 옵션은 ***를 설정한다',
               formFields: [{
                  type: "code-combo",
                  properties: {
                     name: "first_seg_role",
                     codeName: "SEGMENT_ROLE"
                  }
               }]
            }]
         }]
         */
         formSmithing: function () {
            var ol = this.lastResponse; // 옵션 목록

            var map = this.optionNameMap; // 알고있는 옵션 폼 정보 가져옴

            var contContents = {};

            for (let i = 0, len = ol.length; i < len; i++) {
               // mps.mpi 또는 com.mpi로 시작하지 않는 옵션들은 무시함
               let name = ol[i].name;
               let optionName = name.split('.', 2).toString();

               switch (true) {
                  case optionName !== "mps,mpi" && optionName !== "com,mpi": 
                  case map[name] && map[name].hidden : {
                     continue;
                  } break;
               }

               let key = ol[i].name.split('.', 3).join('.');

               if (!contContents[key]) {
                  contContents[key] = {};
                  // TODO default 옵션 정보 조회 시 표시?
                  contContents[key].title = Things.DataGlobal.t('title.' + key.replace(/\./g, '_'));
                  contContents[key].options = [];
               }

               let optionTitle = ol[i].name.split('.');
               optionTitle.shift();
               optionTitle.shift();
               optionTitle.shift();
               optionTitle = optionTitle.join('_');

               let option = {};
               option.title = Things.DataGlobal.t('title.' + optionTitle);
               option.description = ol[i].description ? ol[i].description : '';
               option.optionId = ol[i].id;
               let mapKey = option.name = ol[i].name;

               let mappedOption = this.optionNameMap[mapKey];
               if (mappedOption) {
                  option.formFields = JSON.parse(JSON.stringify(mappedOption.formFields));

                  let values = mappedOption.makeFormData(ol[i].value);
                  for(let j = 0, len = option.formFields.length; j < len; j++){
                     option.formFields[j].properties.value = values[j];
                  }
                  option.getValue = mappedOption.getValue || function () {
                     return this.firstChild.value || '';
                  };
               } else {
                  option.formFields = [{ 
                     type: 'text', 
                     properties: { 
                        name: ol[i].name, 
                        value: ol[i].value
                     }
                  }];
                  option.getValue = function () {
                     return this.firstChild.value || '';
                  }
               }

               // 고객사가 지정된 상태에서는 공통 설정 수정 불가
               if (this.currentCompany !== '' && optionName === 'mps,mpi') {
                  for (let i = 0, len = option.formFields.length; i < len; i++) {
                     option.formFields[i].properties.readonly = true;
                  }
               }

               contContents[key].options.push(option);
            }

            var optionContainer = Object.values(contContents);
            return optionContainer;
         },

         _lastResponseChanged: function (newValue, oldValue) {
            for (let i = 0, len = newValue.length; i < len; i++) {
               this.currentValues[newValue[i].id] = newValue[i];
            }
         },

         // 변경된 설정값들을 반환
         getUpdatedValues: function () {
            var nodeList = this.$['option-container'].querySelectorAll('.input-wrapper');
            var values = JSON.parse(JSON.stringify(this.currentValues)); // copy object
            var updatedValues = [];

            for (let i = 0, len = nodeList.length; i < len; i++) {
               let id = nodeList[i].optionId;
               let cValue = nodeList[i].getValue();
               if ((values[id].value || '') !== cValue) {
                  values[id].value = cValue;
                  updatedValues.push(values[id]);
               }
            }

            return updatedValues;
         },

         // 변경된 설정들을 서버에 업데이트 요청
         updateSetting: function (e) {
            var updatedValues = this.getUpdatedValues();
            if (updatedValues.length === 0) {
               this.openInfoMsg({
                  title: Things.DataGlobal.t('title.info'),
                  text: Things.DataGlobal.t('text.NOTHING_CHANGED'),
                  type: 'info'
               });
            } else {
               var ajax = this.$['update-ajax'];
               ajax.params = {};
               if (this.currentCompany) ajax.params = { com_cd: this.currentCompany };
               ajax.body = updatedValues;
               ajax.generateRequest();
            }
         }
      });
   </script>
</dom-module>