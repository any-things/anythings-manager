<!--
@license
Copyright © HatioLab Inc. All rights reserved.
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/things-ajax/things-ajax.html">
<link rel="import" href="../../bower_components/things-form/things-search-form.html">
<link rel="import" href="../../bower_components/things-grid/things-resource-grid.html">
<link rel="import" href="../../bower_components/things-detail/things-menu-detail-grid.html">

<link rel="import" href="../../bower_components/things-content/things-menu-grid-content-behavior.html">

<dom-module id="mps-box-result">
  <template>
    <style>
		:host {
			display: block;
			@apply --layout-vertical;
		}

		.subtitle:before {
			content: "";
			@apply --things-subtitle-icon;
		}

		.subtitle {
			@apply --things-default-padding;
			padding-bottom: 7px;
			@apply --things-subtitle;
		}

		things-resource-grid {
			@apply --things-default-padding;
			padding-top: 0px;
			padding-bottom: 0px;
		}

		.things-resource-grid-main {
			@apply --layout-flex;
		}

		.things-resource-grid-sub {
			@apply --layout-flex;
			min-height: 200px;
		}
    </style>

		<things-ajax
			auto
			id="resource-meta"
			method="GET"
			resource-url="[[menuMetaUrl]]"
			last-response="{{metaData}}">
    </things-ajax>

    <things-ajax
      id="unboxing-ajax"
      method="DELETE"
      content-type="application/json"
      resource-url="box_result/cancel_boxing/:id">
    </things-ajax>
    
		<things-search-form
			id="search-form"
			title="[[menuInfo.title]]"
			form-fields="[[searchFormFields]]"
			select-fields="[[selectFields]]"
			sort-fields="[[sortFields]]"
			action-url="[[menuInfo.resource_url]]"
			page="{{page}}"
      limit="[[limit]]"
      last-response="{{lastResponse}}">
    </things-search-form>

    <span class="subtitle">[[menuInfo.title]]</span>

		<things-resource-grid
			id="grid"
			class="things-resource-grid-main"
			grid-height="[[gridHeight]]"
			model="[[gridModel]]"
			columns="[[gridColumns]]"
			config="[[gridConfig]]"
			buttons="[[buttons]]"
			current-page="{{page}}"
			limit="{{limit}}"
			data="[[items]]"
			total-count="[[itemCount]]"
			fixed-column-count="[[menuInfo.fixed_columns]]"
			grid-save-action="[[menuInfo.grid_save_url]]"
			export-file-name="[[menuInfo.title]]"
			export-sheet-name="[[menuInfo.title]]">
		</things-resource-grid>

		<span class="subtitle">[[detailTitle]]</span>

		<things-menu-detail-grid
			id="sub-grid"
			class="things-resource-grid-sub"
			grid-config="[[gridConfig]]"
			grid-model="[[detailGridModel]]"
			grid-columns="[[detailGridColumns]]"
			data="[[detailItems]]"
			search-url="[[detailSearchUrl]]"
			save-url="[[detailSaveUrl]]"
			buttons="[[detailButtons]]"
			resource="[[resource]]"
			resource-id="[[resourceId]]">
		</things-menu-detail-grid>
  </template>

  <script>
    Polymer({
      is: 'mps-box-result',

			behaviors: [
				Things.MenuGridContentBehavior
			],

      properties: {
				/**
				 * 메뉴 ID
				 */
         menuId: {
					type: String
				},

				/**
				 * 상세 화면 구성을 위해 필요한 메뉴 메타 데이터를 조회하기 위한 URL
				 */
				menuDetailMetaUrl: {
					type: String,
					computed: '_computeMenuDetailMetaUrl(menuId)',
					observer: '_invokeDetailMetaData'
				},

				/**
				 * 마스터 데이터를 마스터 그리드에 표시할 select 필드
				 */
				masterSelectFields: {
					type: String
				},

				/**
				 * 메뉴 Detail 화면 구성을 위한 메타 데이터
				 */
				detailMetaData: {
					type: Array,
					observer: '_parseDetailMetaData'
				},

				/**
				 * 상세 그리드 모델
				 */
				detailGridModel: {
					type: Object
				},

				/**
				 * 상세 그리드 컬럼
				 */
				detailGridColumns: {
					type: Array
				},

				/**
				 * 상세 조회 URL
				 */
				detailSearchUrl: {
					type: String
				},

				/**
				 * 상세 저장 URL
				 */
				detailSaveUrl: {
					type: String
				},

				/**
				 * 상세 그리드의 바인딩 데이터
				 */
				detailItems: {
					type: Array
				},

				/**
				 * 상세 그리드 데이터가 참조할 마스터 필드명
				 */
				masterField: {
					type: String
				},

				/**
				 * 상세 그리드 제목
				 */
				detailTitle: {
					type: String
				}
      },

			listeners: {
				'grid.things-grid-detail-tap': 'resetResource',
				'grid.things-grid-row-data-select': 'resetResource',
				'sub-grid.things-grid-handle-save': '_beforeDetailsSave',
        'grid.unboxing-btn-tap': 'unboxing',
        'unboxing-ajax.things-ajax-response': '_unboxingResponsed'
			},

			observers: [
				'_gridColumnsChanged(gridColumns)'
			],

			/**
 			 * 마스터 그리드 컬럼이 변경된 이후
 			 * @param {Object} gridColumns 그리드 컬럼
 			 *********
			 */
			_gridColumnsChanged: function(gridColumns) {
				var selectColumns = '';

				gridColumns.forEach(function(metaData) {
					if(!metaData.virtual_field || metaData.virtual_field == false) {
						selectColumns += metaData.name + ',';
					}
				});

				if(selectColumns.length > 2) {
					this.masterSelectFields = selectColumns.substr(0, selectColumns.length - 1);
				}
			},

			/**
 			 * 메뉴 디테일 메타 정보 조회
 			 * @param {String} menuDetailMetaUrl
 			 *********
			 */
			_invokeDetailMetaData: function(menuDetailMetaUrl) {
				var detailMetaAjax = document.createElement('things-ajax');
				detailMetaAjax.resourceId = this.menuId;
				detailMetaAjax.resourceUrl = menuDetailMetaUrl;
				detailMetaAjax.addEventListener('things-ajax-response', function(event) {
					this.detailMetaData = event.detail;
				}.bind(this));

				detailMetaAjax.generateRequest();
			},

			/**
			 * menuId로 부터 메뉴 상세 메타 데이터 조회를 위한 URL을 생성
			 * *******
			 * @param {String} menuId 메뉴 아이디
			 * @return {String} 메뉴 상세 메타 데이터 조회를 위한 URL
			 */
			_computeMenuDetailMetaUrl: function(menuId) {
				return 'menu_details/' + menuId + '/meta';
			},

			/**
			 * 서버로 부터 응답받은 메뉴 상세에 대한 메타 데이터를 상세 화면 구성을 위해 필요한 메타 데이터로 변환한다.
			 * *******
			 * @param {Array} detailMetaList 서버로 부터 응답받은 메뉴 상세에 대한 메타 데이터
			 */
			_parseDetailMetaData: function(detailMetaList) {
				if(!detailMetaList || detailMetaList.length == 0) {
					return;
				}

				for(var i = 0 ; i < detailMetaList.length ; i++) {
					var metaData = detailMetaList[i];

					if(metaData.association != 'one-to-many') {
						continue;
					}

					this.detailTitle = metaData.name;
					this.detailSearchUrl = metaData.search_url;
					this.detailSaveUrl = metaData.save_url;
					this.masterField = metaData.master_field;

					if(metaData.menu_detail_buttons) {
						var buttons = this._parseButtons(metaData.menu_detail_buttons);
						if(buttons && buttons.length > 0) {
							buttons.forEach(function(button) { button.id = button.name + '-btn'; });
						}

						this.detailButtons = buttons;
					}

					if(metaData.menu_detail_columns) {
						// Parse Grid Models - Grid
						this.detailGridModel = this._parseGridModel(metaData.menu_detail_columns);

						// Parse Grid Columns - Grid
						this.detailGridColumns = this._parseGridColumns(metaData.menu_detail_columns);
					}
				}

				this.fire('detail-meta-data-configured');
			},

			/**
			 * 상세 그리드 데이터 저장 전 처리 ...
			 * *******
			 * @param {Object} event
			 */
			_beforeDetailsSave: function(event) {
				var detailGrid = event.target;
				var changedList = detailGrid.writeData;
				if (!changedList || changedList.length == 0) {
					return event;
				}

				changedList.forEach(function(changedData) {
					if (changedData.cud_flag_ == 'c' || changedData.cud_flag_ == 'd') {
						changedData[this.masterField] = this.resourceId;
					}
				}.bind(this));

				return event;
			},

			/**
			 * 마스터 데이터 조회
			 * *******
			 * @param {Object} event
			 */
			refreshMaster: function(event) {
				this.$['search-form'].submitMyForm();
			},

			/**
			 * 그리드 Detail 버튼 선택 시 ...
			 * *******
			 * @param {Object} event 그리드 Detail 버튼 선택 이벤트
			 */
			resetResource: function(event) {
				this.resource = event.detail;
				this.resourceId = this.menuInfo.id_field ? this.resource[this.menuInfo.id_field] : this.resource.id;
			},

      /**
       * 박싱 취소 버튼 클릭 event handler
       * 현재 그리드 중 체크 아이콘에 체크된 모든 항목을 추출하여 ID를 추출하고
       * unboxing 서비스를 호출 함
       */
      unboxing: function() {
        try {
          var checkedRowObj = this.getCheckedRowObject();
          var unboxingAjax = this.$['unboxing-ajax'];
          unboxingAjax.resourceId = checkedRowObj.id
          unboxingAjax.generateRequest();
        } catch (e) {
          this.openInfoMsg({
            type: 'error',
            title: e.title,
            text: e.text
          })
        }
      },

      /**
       * unboxing ajax response event handler
       * 박싱 취소가 정상적으로 완료되면 search-form을 통해 데이터를 재조회 함
       */
      _unboxingResponsed: function() {
        this.$['search-form'].submitMyForm();
      },

      /**
       * 그리드에서 체크된 항목을 추출하여 체크된 항목의 id array를 리턴
       */
      getCheckedRowObject: function() {
        var gridObject = this.$['grid'].getGridObject();
        var checkedRows = gridObject.getCheckedRows();

				if(checkedRows && checkedRows.length === 1) {
					// 1. 하나만 선택하고 아이디가 있을 경우 => 정상
					var checkedRowObj = checkedRows[0].getRowObject();
					if(checkedRowObj.id) {
						return checkedRowObj;
					} else {
						// 2. 하나 선택하고 아이디가 없을 경우
						throw {
							title: Things.DataGlobal.t('text.VALUE_IS_NOT_EXIST', { value: Things.DataGlobal.t('label.id') }),
							text: Things.DataGlobal.t('text.please_select_items_in_x_grid', { x: Things.DataGlobal.t('menu.BoxResult') })
						}
					}			
				} else if (checkedRows && checkedRows.length > 1) {
					throw {
						title: Things.DataGlobal.t('text.select_only_one_item'),
						text: Things.DataGlobal.t('text.please_select_items_in_x_grid', { x: Things.DataGlobal.t('menu.BoxResult') })
					}
				} else if (!checkedRows || checkedRows.length === 0) {
					throw {
            title: Things.DataGlobal.t('text.NOTHING_SELECTED'),
            text: Things.DataGlobal.t('text.please_select_items_in_x_grid', { x: Things.DataGlobal.t('menu.BoxResult') })
					}
				}
      }
    })
  </script>
</dom-module>