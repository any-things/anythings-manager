<!--
@license
Copyright © HatioLab Inc. All rights reserved.
-->
<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/things-ajax/things-ajax.html">
<link rel="import" href="../../bower_components/things-form/things-search-form.html">
<link rel="import" href="../../bower_components/things-grid/things-resource-grid.html">
<link rel="import" href="../../bower_components/things-content/things-resource-menu-content-behavior.html">

<link rel="import" href="company-setting-advanced.html">
<link rel="import" href="basic-setting-add-popup.html">

<dom-module id="basic-setting">
   <template>
      <style>
         :host {
            @apply --layout-vertical;
            padding: 5px 15px 0 15px;

            --small-gap: 5px;
            --normal-gap: 10px;
            --default-gap: 15px;
            --large-gap: 20px;
         }

         paper-toolbar::shadow #bottomBar {
            @apply --layout-horizontal;
            @apply --layout-end-justified;
         }

         #container {
            @apply --layout-flex;

            display: grid;
            grid-template-rows: auto 1fr auto;
            grid-gap: var(--default-gap);
         }

         #option-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-auto-rows: minmax(300px, 100%);
            grid-gap: var(--large-gap);

            overflow-y: scroll;
         }

         #option-container>div {
            display: grid;
            grid-template-rows: auto 1fr;
            grid-gap: var(--small-gap);
         }

         .option-block {
            @apply --layout-vertical;

            padding: 0 var(--default-gap);

            background: white;
            border-radius: 5px;
            overflow-x: auto;
            overflow-y: scroll;
         }

         .option {
            display: grid;
            grid-template: auto / 1fr;
            padding: var(--large-gap) 0;

            border-bottom: 1px dashed #EEE;
         }

         .input-wrapper {
            display: flex;
            flex-wrap: wrap;
            margin: 0 calc(-1 * var(--normal-gap));
         }

         .input-wrapper>* {
            flex: 1 1 100px;
            margin: 0 var(--normal-gap) var(--normal-gap) var(--normal-gap);
         }

         .title {
            color: white;
            font-size: 15pt;
         }

         .subtitle {
            font-size: 12pt;
            color: black;
            padding: 0;
         }

         .subtitle:before {
            content: '';
            @apply --things-subtitle-icon;
         }

         .description {
            color: #AAA;
            font-size: 10pt;
         }

         /* 바깥 여백 제거 */

         .margin-zero {
            margin: 0px;
         }

         /* 안쪽 여백 제거 */

         .padding-zero {
            padding: 0px;
         }

         p {
            word-break: break-all;
            margin: 0 0 var(--normal-gap) 0;
         }

         .things-combo-field {
            display: grid;
            grid-template: "a b"auto / minmax(40px, 1fr) auto;
            grid-gap: 5px;

            --things-label: {
               display: none;
            }

            --things-input: {
               width: auto !important;
               padding: 3px 5px 2px 5px;
               -webkit-border-radius: 4px;
               -moz-border-radius: 4px;
               border-radius: 4px;
               border: 1px solid rgba(117, 60, 60, 0.2);
               font-size: 15px;
               font-weight: 300;
            }

            --things-picker-button: {
               width: 30px;
               height: 25px;
               margin-left: 2px;
               -webkit-border-radius: 3px;
               -moz-border-radius: 3px;
               border-radius: 3px;
            }
         }

         .things-combo-field>input.input-size:not(#input) {
            grid-area: a;
         }

         .things-combo-field>iron-icon {
            grid-area: b;
         }

         /* 인풋 필드 */

         .things-field {
            display: grid;
            grid-auto-rows: auto;

            --things-label: {
               display: none !important;
            }

            --things-input: {
               width: auto !important;
               padding: 3px 5px 2px 5px;
               -webkit-border-radius: 4px;
               -moz-border-radius: 4px;
               border-radius: 4px;
               border: 1px solid rgba(0, 0, 0, .2);
               font-size: 15px;
               font-weight: 300;
            }
         }
      </style>

      <things-ajax auto id="resource-meta" resource-url="[[menuMetaUrl]]" resource-action="index" last-response="{{metaData}}">
      </things-ajax>

      <things-ajax id="update-ajax" method="POST" content-type="application/json" resource-url="[[menuInfo.grid_save_url]]"
         last-response="{{lastResponse}}">
      </things-ajax>

      <div id="container">
         <things-search-form id="search-form" class="margin-zero" form-fields="[[searchFormFields]]" select-fields="[[selectFields]]"
            sort-fields="[[sortFields]]" action-url="[[menuInfo.resource_url]][[addedUrl]]" last-response="{{lastResponse}}">
         </things-search-form>
         <div id="option-container"></div>
         <paper-toolbar>
            <div class="bottom">
               <things-button-bar id="button-group" buttons="[[buttons]]"></things-button-bar>
            </div>
         </paper-toolbar>
      </div>
   </template>

   <script>
      Polymer({
         is: 'basic-setting',

         behaviors: [
            Things.ResourceMenuContentBehavior
         ],

         properties: {
            addedUrl: {
               type: String,
               value: function () {
                  return "/override_default_setting";
               }
            },

            lastResponse: {
               type: Array,
               observer: '_lastResponseChanged'
            },

            currentKey: {
               type: String,
               value: function () {
                  return '';
               }
            },

            currentValues: {
               type: Object,
               value: function () {
                  return {};
               }
            },

            // 서버에서 받은 설정값을 인풋 폼의 개수에 맞춰 인풋 폼 각각에 나눠서 적용한다.
            makeFormDataFunctions: {
               type: Object,
               value: function () {
                  return {
                     "one": function (value) {
                        return [value];
                     },
                     "n": function (value, separator = ',') {
                        var values = value.split(separator);
                        return values;
                     }
                  };
               }
            },

            // 서버로 설정값을 올릴 때, 폼에 들어있는 값들을 모아 하나의 값으로 만든다.
            getValueFunctions: {
               type: Object,
               value: function () {
                  return {
                     "one": function () {
                        return this.firstChild.value || '';
                     },
                     "n": function (separator = ',') {
                        var forms = this.childNodes;
                        var result = [];
                        for (let i = 0, len = forms.length; i < len; i++) {
                           result.push(forms[i].value);
                        }
                        return result.join(separator);
                     }
                  }
               }
            }
         },

         listeners: {
            "search-form.things-form-submit-configured": "_beforeSearch",
            "search-form.things-form-submit-success": "_searchSuccess",
            "search-form.things-form-submit-error": "_searchFailed",
            "update-ajax.things-ajax-response": "_updateSuccess",
            "button-group.save-btn-tap": "updateSettings",
            "button-group.advanced-btn-tap": "openAdvancedView",
            "button-group.add-btn-tap": "openSettingNameInput"
         },

         // 검색 직전 이벤트
         _beforeSearch: function (e) {
            // 기존 옵션 블록들을 제거. 고객사 미선택 상태로 변경
            this.purgeOptionContainer();
            this.currentKey = '';

            // 고객사 코드 입력란이 비어있으면 '_DEFAULT_'로 검색
            var oldParam = e.detail.request.params;
            var newParam = oldParam;
            var newQuery = newParam.query;
            if (!newQuery) newQuery = [];
            else newQuery = JSON.parse(newQuery);
            let key = newQuery.find(function (value) {
               return value.name === 'set_name';
            });
            if (key) {
               return;
            } else {
               newQuery.push({
                  name: "set_name",
                  operator: "eq",
                  value: "_DEFAULT_"
               });
            }
            e.detail.request.params.query = JSON.stringify(newQuery);
         },

         // 검색 성공 시
         _searchSuccess: function (e) {
            this.purgeOptionContainer();
            this.currentKey = this.$['search-form'].serializeMyForm().set_name || "_DEFAULT_";
            this.createOptionDiv();
         },

         // 검색 실패 시
         _searchFailed: function (e) {
            this.purgeOptionContainer();
            // 선택 고객사 없음
            this.currentKey = '';
         },

         // 업데이트 성공 시
         _updateSuccess: function () {
            this.refreshData();
         },

         purgeOptionContainer: function () {
            // 모든 옵션 블록 제거
            var cont = this.$['option-container'];
            while (cont.firstChild) cont.removeChild(cont.firstChild);
         },

         // 최초 옵션 분류. 타이틀이 포함된 옵션 블록을 생성
         createOptionDiv: function () {
            var cont = this.$['option-container'];

            // 구성된 폼으로 엘리먼트 생성
            var form = this.formSmithing();
            for (let i = 0, len = form.length; i < len; i++) {
               // 타이틀과 옵션 블록을 포함하는 div 생성
               let optionDiv = this.create('div');
               optionDiv.setAttribute('class', 'style-scope basic-setting');

               // 타이틀 생성
               let title = this.createSpan('title', form[i].title);
               optionDiv.appendChild(title);

               // 옵션들이 들어갈 블록 생성
               let optionBlock = this.createOptionBlock(form[i].options);
               optionDiv.appendChild(optionBlock);

               // 컨테이너에 적용
               cont.appendChild(optionDiv);
            }
         },

         // 옵션 블록의 내용. 옵션 블록 내에 옵션 목록을 생성
         createOptionBlock: function (options) {
            var optionBlock = this.create('div');
            optionBlock.setAttribute('class', 'option-block style-scope basic-setting');

            // 주어진 개수만큼 옵션 목록 생성
            for (let i = 0, len = options.length; i < len; i++) {
               let option = this.createOption(options[i])
               optionBlock.appendChild(option);
            }

            return optionBlock;
         },

         // 각 옵션 생성. 타이틀, 설명, 입력 박스를 포함함
         createOption: function (option) {
            var row = this.create('div');
            row.setAttribute('class', 'option style-scope basic-setting');

            // create and set title
            let title = this.createSpan('subtitle', option.title);
            row.appendChild(title);

            // create and set description
            let p = this.create('p', { innerText: option.description });
            p.setAttribute('class', 'description style-scope basic-setting');
            row.appendChild(p);

            // create and set input form
            let props = {
               name: option.name,
               getValue: this.getValueFunctions[option.getValue || 'one'],
               separator: option.separator
            };
            let form = this.createInputForm(option.formFields, props);
            row.appendChild(form);

            return row;
         },

         // 입력용 박스 생성
         createInputForm: function (formFields, properties) {
            let wrapper = this.create('div', properties);
            wrapper.setAttribute('class', 'input-wrapper style-scope basic-setting');

            for (let i = 0, len = formFields.length; i < len; i++) {
               let form;
               switch (formFields[i].type) {
                  case 'number': {
                     form = this.create('things-number-field', formFields[i].properties);
                     form.setAttribute('class', 'option-input things-field style-scope basic-setting');
                  } break;
                  case 'combo': {
                     form = this.create('things-combo', formFields[i].properties);
                     form.setAttribute('class', 'option-input things-combo-field style-scope basic-setting');
                  } break;
                  case 'code-combo': {
                     form = this.create('things-combo', formFields[i].properties);
                     form.setAttribute('class', 'option-input things-combo-field style-scope basic-setting');

                     // create ajax
                     let props = {
                        auto: true,
                        resourceUrl: 'common_codes/show_by_name',
                        method: 'GET',
                        params: {
                           name: formFields[i].properties.codeName
                        },
                        comboElement: form
                     };
                     let codeAjax = this.create('things-ajax', props);
                     // add event listener
                     this.listen(codeAjax, 'things-ajax-response', 'setComboItems');
                  } break;
                  case 'text':
                  default: {
                     form = this.create('things-input-field', formFields[i].properties);
                     form.setAttribute('class', 'option-input things-field style-scope basic-setting');
                  } break;
               }
               wrapper.appendChild(form);
            }

            return wrapper;
         },

         // code-combo 타입 전용) 콤보 박스 아이템 설정
         setComboItems: function (e) {
            e.target.comboElement.items = e.detail.items;
         },

         // 라벨(타이틀)을 생성하는 함수
         createSpan: function (cssClassName, innerText) {
            var span = this.create('span');
            span.setAttribute('class', cssClassName + ' style-scope basic-setting');
            span.innerText = innerText;

            return span;
         },

         /* 규격에 맞는 폼을 만들고 반환함. 예시)
         [{
            title: 'ABC 옵션',
            options: [{
               title: 'A 옵션',
               description: '이 옵션은 A을/를 설정한다',
               formFields: [{
                  type: "code-combo",
                  properties: {
                     name: "first_seg_role",
                     codeName: "SEGMENT_ROLE",
                     ...
                  }
               }, ...]
            }, ...]
         }, ...]
         */
         formSmithing: function () {
            if (this.lastResponse == null || this.lastResponse.items == null || this.lastResponse.items.length == 0) {
               return [];
            }

            var ol = this.lastResponse.items; // 옵션 목록
            var contContents = {};

            for (let i = 0, len = ol.length; i < len; i++) {
               let name = ol[i].name;
               let optionName = name.split('.', 2).toString();

               // 서버에서 내려주는 구성값 사용
               let conf;
               try {
                  conf = JSON.parse(ol[i].config);
               } catch (e) {
                  conf = false;
               }

               // 서버에서 내려준 값을 화면에 그리지 않는 케이스 지정
               switch (true) {
                  // case optionName !== "com,mps":
                  case conf && conf.hidden: {
                     continue;
                  } break;
               }

               let key = ol[i].name.split('.', 3).join('.');

               if (!contContents[key]) {
                  contContents[key] = {};
                  // TODO default 옵션 정보 조회 시 표시?
                  contContents[key].title = Things.DataGlobal.t('title.' + key.replace(/\./g, '_'));
                  contContents[key].options = [];
               }

               let optionTitle = ol[i].name.split('.');
               optionTitle.shift();
               optionTitle.shift();
               optionTitle.shift();
               optionTitle = optionTitle.join('_');

               let option = {};
               option.title = Things.DataGlobal.t('title.' + optionTitle);
               option.description = ol[i].description ? ol[i].description : '';
               option.name = ol[i].id;

               if (conf) {
                  try {
                     option.formFields = JSON.parse(JSON.stringify(conf.formFields));
                  } catch (exception) {
                     option.formFields = [{
                        type: 'text',
                        properties: {
                           value: ol[i].value
                        }
                     }];
                  }

                  // 각각의 폼에 값 넣어주기
                  let values = this.makeFormDataFunctions[conf.makeFormData || 'one'](ol[i].value, conf.separator);

                  for (let j = 0, len = option.formFields.length; j < len; j++) {
                     if (!(typeof option.formFields[j].properties === 'object')) {
                        option.formFields[j].properties = {};
                     }
                     option.formFields[j].properties.value = values[j];
                  }
                  option.getValue = conf.getValue || function () {
                     return this.firstChild.value || '';
                  };
                  option.separator = conf.separator;
               } else {
                  option.formFields = [{
                     type: 'text',
                     properties: {
                        value: ol[i].value
                     }
                  }];
                  option.getValue = "one";
                  option.makeFormData = "one";
               }

               contContents[key].options.push(option);
            }

            var optionContainer = Object.values(contContents);
            return optionContainer;
         },

         // 검색으로 받은 값이 바뀔 때마다 호출
         _lastResponseChanged: function (newValue, oldValue) {
            // 현재 옵션 상태를 저장
            // 업데이트 시 변경된 옵션을 알기 위해서임
            var items = newValue.items;
            if (typeof items === "object") {
               for (let i = 0, len = items.length; i < len; i++) {
                  let id = items[i].id;
                  this.currentValues[id] = items[i];
               }
            }
         },

         // 추가 버튼 탭 시 새로운 옵션 세트 이름 입력 팝업
         openSettingNameInput: function (e) {
            var screen = this;
            var view = this.create('basic-setting-add-popup', {
               title: Things.DataGlobal.t('menu.BasicSetting'),
               menuInfo: this.menuInfo,
               currentKey: this.currentKey,
               close: function () {
                  screen.fire('things-dialog-close');
               }
            });

            this.fire('things-open-custom-size-dialog', {
               view: view,
               modal: true,
               dialogSize: 'small',
               closeCallback: function () {
                  this.refreshData();
               }.bind(this)
            });
         },
         
         // 그리드 방식 화면 팝업 
         openAdvancedView: function (e) {
            searchForm = this.$['search-form'];
            var view = this.create('company-setting-advanced', {
               title: Things.DataGlobal.t("menu.CompanySetting"),
               menuInfo: this.menuInfo
            });

            this.fire('things-open-popup-view', {
               view: view,
               modal: true,
               closeCallback: function () {
                  searchForm.submitMyForm();
               }
            });
         },

         // 변경된 설정값들을 반환
         getUpdatedValues: function () {
            var nodeList = this.$['option-container'].querySelectorAll('.input-wrapper');
            var values = JSON.parse(JSON.stringify(this.currentValues)); // copy object
            var updatedValues = [];

            for (let i = 0, len = nodeList.length; i < len; i++) {
               let name = nodeList[i].name;
               let cValue = nodeList[i].getValue(nodeList[i].separator);
               if ((values[name].value || '') !== cValue) {
                  values[name].value = cValue;
                  let uFlagValue = values[name];
                  if (this.currentKey != '_DEFAULT_' && values[name].set_name == '_DEFAULT_') {
                     uFlagValue.id = null;
                     uFlagValue.set_name = this.currentKey;
                     uFlagValue.creator_id = null;
                     uFlagValue.created_at = null;
                     uFlagValue.updater_id = null;
                     uFlagValue.updated_at = null;
                     uFlagValue.cud_flag_ = 'c';
                  } else {
                     uFlagValue.cud_flag_ = 'u';
                  }
                  updatedValues.push(uFlagValue);
               }
            }

            return updatedValues;
         },

         // 변경된 설정들을 서버에 업데이트 요청
         updateSettings: function (e) {
            var updatedValues = this.getUpdatedValues();
            if (updatedValues.length === 0) {
               this.openInfoMsg({
                  title: Things.DataGlobal.t('title.info'),
                  text: Things.DataGlobal.t('text.NOTHING_CHANGED'),
                  type: 'info'
               });
            } else {
               var ajax = this.$['update-ajax'];
               ajax.params = {};
               if (this.currentKey) ajax.params = { set_name: this.currentKey };
               ajax.body = updatedValues;
               ajax.generateRequest();
            }
         }
      });
   </script>
</dom-module>